(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7711],{3145:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>eQ});var i=s(95155),r=s(12115),t=s(20063),n=s(54901),l=s(35434),o=s(92033),d=s(22452),c=s(59007),u=s(21799),m=s(28127),h=s(50817),x=s(90109),p=s(94979),j=s(23107),g=s(53489),v=s(86948),f=s(3998),N=s(6259),b=s(13406),A=s(22544),y=s(66942),w=s(15653),S=s(65142),C=s(51834),E=s(41052),D=s(15894),k=s(14585),P=s(19708),z=s(30848),I=s(72251),V=s(63260),O=s(11186),R=s(63817),M=s(26333),L=s(34238),_=s(64269);let B=w.z.object({ne:w.z.string().min(1,"El NE es requerido."),consignee:w.z.string().min(1,"El Consignatario es requerido."),declarationPattern:w.z.string().min(1,"El Modelo (Patr\xf3n) es requerido."),merchandise:w.z.string().min(1,"La Mercanc\xeda es requerida."),aforador:w.z.string().min(1,"El nombre del Aforador es requerido."),totalPosiciones:w.z.coerce.number({invalid_type_error:"Debe ser un n\xfamero."}).optional(),assignmentDate:w.z.date({required_error:"La fecha de asignaci\xf3n es requerida."}),executive:w.z.string().min(1,"El ejecutivo es requerido.")});function $(e){let{isOpen:a,onClose:s}=e,{user:t}=(0,n.A)(),{toast:l}=(0,D.dj)(),[d,c]=(0,r.useState)([]),u=(0,A.mN)({resolver:(0,y.u)(B),defaultValues:{ne:"",consignee:"",declarationPattern:"",merchandise:"",aforador:"",assignmentDate:new Date,executive:""}});(0,r.useEffect)(()=>{(null==t?void 0:t.displayName)&&u.setValue("aforador",t.displayName),(async()=>{let e=(0,P.P)((0,P.rJ)(k.db,"users"),(0,P._M)("role","==","ejecutivo"));c((await (0,P.GG)(e)).docs.map(e=>({uid:e.id,...e.data()})))})()},[t,u]);let m=async e=>{if(!t)return void l({title:"Error",description:"Debe estar autenticado.",variant:"destructive"});let a=e.ne.trim().toUpperCase(),i=(0,P.H9)(k.db,"AforoCases",a);try{if((await (0,P.x7)(i)).exists())return void l({title:"Registro Duplicado",description:"Ya existe un caso de aforo con este NE. No se puede crear de nuevo.",variant:"destructive"});await (0,P.BN)(i,{...e,ne:a,createdBy:t.uid,createdAt:(0,P.O5)(),revisorStatus:"Pendiente"}),l({title:"Registro Creado",description:"El caso de aforo para el NE ".concat(a," ha sido guardado.")}),s(),u.reset()}catch(e){console.error("Error creating aforo case: ",e),l({title:"Error",description:"No se pudo crear el registro de aforo.",variant:"destructive"})}};return a?(0,i.jsx)(C.lG,{open:a,onOpenChange:s,children:(0,i.jsxs)(C.Cf,{className:"sm:max-w-xl",children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{className:"text-xl",children:"Nuevo Registro de Aforo"}),(0,i.jsx)(C.rr,{children:"Complete los datos para registrar un nuevo caso de aforo."})]}),(0,i.jsx)(E.lV,{...u,children:(0,i.jsxs)("form",{onSubmit:u.handleSubmit(m),className:"space-y-4 py-4",children:[(0,i.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,i.jsx)(E.zB,{control:u.control,name:"ne",render:e=>{let{field:a}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"NE"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(S.p,{...a})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsx)(E.zB,{control:u.control,name:"consignee",render:e=>{let{field:a}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"Consignatario / Cliente"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(S.p,{...a})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsx)(E.zB,{control:u.control,name:"executive",render:e=>{let{field:a}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"Asignar Ejecutivo"}),(0,i.jsxs)(O.l6,{onValueChange:a.onChange,defaultValue:a.value,children:[(0,i.jsx)(E.MJ,{children:(0,i.jsx)(O.bq,{children:(0,i.jsx)(O.yv,{placeholder:"Seleccionar ejecutivo..."})})}),(0,i.jsx)(O.gC,{children:d.map(e=>(0,i.jsx)(O.eb,{value:e.displayName||e.email,children:e.displayName||e.email},e.uid))})]}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsx)(E.zB,{control:u.control,name:"declarationPattern",render:e=>{var a;let{field:s}=e;return(0,i.jsxs)(E.eI,{className:"flex flex-col",children:[(0,i.jsx)(E.lR,{children:"Modelo (Patr\xf3n)"}),(0,i.jsxs)(M.AM,{children:[(0,i.jsx)(M.Wv,{asChild:!0,children:(0,i.jsx)(E.MJ,{children:(0,i.jsxs)(f.$,{variant:"outline",role:"combobox",className:(0,_.cn)("w-full justify-between",!s.value&&"text-muted-foreground"),children:[s.value?null==(a=L.h7.find(e=>e.value===s.value))?void 0:a.label:"Seleccionar modelo...",(0,i.jsx)(z.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),(0,i.jsx)(M.hl,{className:"w-[--radix-popover-trigger-width] p-0",children:(0,i.jsxs)(R.uB,{children:[(0,i.jsx)(R.G7,{placeholder:"Buscar modelo..."}),(0,i.jsxs)(R.oI,{children:[(0,i.jsx)(R.xL,{children:"No se encontr\xf3 el modelo."}),(0,i.jsx)(R.L$,{children:L.h7.map(e=>(0,i.jsxs)(R.h_,{value:e.label,onSelect:()=>u.setValue("declarationPattern",e.value),children:[(0,i.jsx)(I.A,{className:(0,_.cn)("mr-2 h-4 w-4",e.value===s.value?"opacity-100":"opacity-0")}),e.label]},e.value))})]})]})})]}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsx)(E.zB,{control:u.control,name:"merchandise",render:e=>{let{field:a}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"Mercanc\xeda"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(S.p,{...a})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsx)(E.zB,{control:u.control,name:"aforador",render:e=>{let{field:a}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"Aforador"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(S.p,{...a,disabled:!0})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsx)(E.zB,{control:u.control,name:"totalPosiciones",render:e=>{var a;let{field:s}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"Total Posiciones"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(S.p,{type:"number",...s,value:null!=(a=s.value)?a:"",onChange:e=>s.onChange(""===e.target.value?void 0:+e.target.value)})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsx)(E.zB,{control:u.control,name:"assignmentDate",render:e=>{let{field:a}=e;return(0,i.jsxs)(E.eI,{className:"flex flex-col",children:[(0,i.jsx)(E.lR,{className:"mb-1",children:"Fecha de Asignaci\xf3n"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(V.I,{date:a.value,onDateChange:a.onChange})}),(0,i.jsx)(E.C5,{})]})}})]}),(0,i.jsxs)(C.Es,{className:"pt-4",children:[(0,i.jsx)(f.$,{type:"button",variant:"outline",onClick:s,children:"Cancelar"}),(0,i.jsxs)(f.$,{type:"submit",disabled:u.formState.isSubmitting,children:[u.formState.isSubmitting&&(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardar Registro"]})]})]})})]})}):null}var U=s(87270),H=s(66065),J=s(60406),T=s(87455),G=s(63263),q=s(68425),F=s(77187),Z=s(27500),W=s(59915),Q=s(36654),X=s(54550),Y=s(82274),K=s(6943),ee=s(88964),ea=s(24820),es=s(27314),ei=s(5351),er=s(56397),et=s(11647),en=s(5282),el=s(48109),eo=s(80160),ed=s(49205),ec=s(46767),eu=s(43854),em=s(13630),eh=s(17037);function ex(e){let{isOpen:a,onClose:s,caseData:t,allUsers:l}=e,{user:d}=(0,n.A)(),{toast:c}=(0,D.dj)(),[u,m]=(0,r.useState)(!1),[h,x]=(0,r.useState)([]);(0,r.useEffect)(()=>{if(a&&t){let e=t.involvedUsers||[];x(l.filter(a=>e.includes(a.uid)))}else x([])},[a,t,l]);let p=l.filter(e=>("aforador"===e.role||"ejecutivo"===e.role||"supervisor"===e.role||"coordinadora"===e.role)&&!h.some(a=>a.uid===e.uid)),j=async()=>{if(!d||!t)return;m(!0);let e=(0,P.H9)(k.db,"AforoCases",t.id),a=(0,P.rJ)(e,"actualizaciones"),i=(0,P.wP)(k.db),r=h.map(e=>e.uid);i.update(e,{involvedUsers:r});let n={updatedAt:P.Dc.now(),updatedBy:d.displayName||"Admin",field:"involvedUsers",oldValue:t.involvedUsers||[],newValue:r,comment:"Usuarios involucrados en la incidencia actualizados."};i.set((0,P.H9)(a),n);try{await i.commit(),c({title:"Lista de Involucrados Actualizada",description:"Los usuarios involucrados en la incidencia han sido guardados."}),s()}catch(e){console.error("Error updating involved users:",e),c({title:"Error",description:"No se pudieron guardar los cambios.",variant:"destructive"})}finally{m(!1)}};return a&&t?(0,i.jsx)(C.lG,{open:a,onOpenChange:s,children:(0,i.jsxs)(C.Cf,{className:"max-w-2xl",children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{children:"Asignar Involucrados en la Incidencia"}),(0,i.jsxs)(C.rr,{children:["Seleccione los usuarios involucrados en la rectificaci\xf3n del caso NE: ",(0,i.jsx)("span",{className:"font-bold text-foreground",children:t.ne}),"."]})]}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-6 py-4",children:[(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsx)("h4",{className:"font-medium text-sm",children:"Usuarios Disponibles"}),(0,i.jsxs)(R.uB,{className:"rounded-lg border shadow-sm",children:[(0,i.jsx)(R.G7,{placeholder:"Buscar usuario..."}),(0,i.jsx)(eh.F,{className:"h-[250px]",children:(0,i.jsxs)(R.oI,{children:[(0,i.jsx)(R.xL,{children:"No hay m\xe1s usuarios que cumplan el criterio."}),(0,i.jsx)(R.L$,{children:p.map(e=>(0,i.jsxs)(R.h_,{value:e.displayName||e.email||"",onSelect:()=>{x(a=>[...a,e])},className:"cursor-pointer",children:[(0,i.jsx)(es.A,{className:"mr-2 h-4 w-4"}),(0,i.jsxs)("div",{className:"flex flex-col",children:[(0,i.jsx)("span",{children:e.displayName||e.email}),(0,i.jsx)("span",{className:"text-xs text-muted-foreground",children:e.role})]})]},e.uid))})]})})]})]}),(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsx)("h4",{className:"font-medium text-sm",children:"Usuarios Involucrados"}),(0,i.jsx)(eh.F,{className:"h-[290px]",children:(0,i.jsx)("div",{className:"rounded-lg border min-h-[280px] p-2 space-y-1",children:h.length>0?h.map(e=>(0,i.jsxs)("div",{className:"flex items-center justify-between p-2 rounded-md hover:bg-accent/50",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(K.A,{className:"h-4 w-4 text-muted-foreground"}),(0,i.jsx)("span",{className:"text-sm",children:e.displayName||e.email})]}),(0,i.jsx)(f.$,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:()=>{var a;return a=e.uid,void x(e=>e.filter(e=>e.uid!==a))},children:(0,i.jsx)(em.A,{className:"h-4 w-4 text-destructive"})})]},e.uid)):(0,i.jsx)("p",{className:"text-sm text-muted-foreground text-center p-8",children:"A\xf1ada usuarios de la lista de la izquierda."})})})]})]}),(0,i.jsxs)(C.Es,{children:[(0,i.jsx)(f.$,{variant:"outline",onClick:s,children:"Cancelar"}),(0,i.jsxs)(f.$,{onClick:j,disabled:u,children:[u&&(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardar Cambios"]})]})]})}):null}var ep=s(44385),ej=s(13496),eg=s(89522);let ev=e=>{let{label:a,children:s}=e;return(0,i.jsxs)("div",{className:"flex justify-between items-center py-2 border-b border-border/50",children:[(0,i.jsx)("p",{className:"text-sm font-medium text-muted-foreground",children:a}),(0,i.jsx)("div",{className:"text-sm text-right text-foreground",children:s})]})},ef=e=>{let{caseItem:a,savingState:s,canEditFields:r,handleAutoSave:t,handleValidatePattern:n,openAssignmentModal:l,openHistoryModal:o,openIncidentModal:d,openAforadorCommentModal:c,openObservationModal:u,handleRequestRevalidation:m,handleAssignToDigitization:h,handleViewWorksheet:j,setSelectedIncidentForDetails:g}=e,b=r||a.aforador&&a.aforador==a.aforador;return a.isPatternValidated,a.revisorStatus,(0,i.jsxs)(v.Zp,{className:"w-full",children:[(0,i.jsx)(v.aR,{children:(0,i.jsxs)("div",{className:"flex justify-between items-start",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)(v.ZB,{className:"font-bold text-lg text-primary",children:a.ne}),(0,i.jsx)("p",{className:"text-sm text-muted-foreground truncate max-w-[200px]",children:a.consignee})]}),(0,i.jsxs)(N.rI,{children:[(0,i.jsx)(N.ty,{asChild:!0,children:(0,i.jsxs)(f.$,{variant:"ghost",className:"h-8 w-8 p-0",children:[(0,i.jsx)("span",{className:"sr-only",children:"Abrir"}),(0,i.jsx)(q.A,{className:"h-5 w-5"})]})}),(0,i.jsxs)(N.SQ,{align:"end",children:[a.worksheetId&&(0,i.jsxs)(N._2,{onSelect:()=>j(a),children:[(0,i.jsx)(F.A,{className:"mr-2 h-4 w-4"})," Ver Hoja de Trabajo"]}),(0,i.jsxs)(N._2,{onSelect:()=>handleSearchPrevio(a.ne),children:[(0,i.jsx)(x.A,{className:"mr-2 h-4 w-4"})," Buscar Previo"]}),(0,i.jsxs)(N._2,{onSelect:()=>u(a),children:[(0,i.jsx)(Q.A,{className:"mr-2 h-4 w-4"})," Ver/Editar Observaci\xf3n"]}),(0,i.jsxs)(N._2,{onSelect:()=>o(a),children:[(0,i.jsx)(W.A,{className:"mr-2 h-4 w-4"})," Ver Bit\xe1cora"]}),b&&(0,i.jsxs)(N._2,{onSelect:()=>d(a),children:[(0,i.jsx)(J.A,{className:"mr-2 h-4 w-4 text-amber-600"})," Reportar Incidencia"]}),a.incidentReported&&(0,i.jsxs)(N._2,{onSelect:()=>g(a),children:[(0,i.jsx)(Q.A,{className:"mr-2 h-4 w-4"})," Ver Incidencia"]}),(a.aforador||r)&&"Rechazado"===a.revisorStatus&&(0,i.jsxs)(N._2,{onSelect:()=>m(a),children:[(0,i.jsx)(X.A,{className:"mr-2 h-4 w-4"})," Solicitar Revalidaci\xf3n"]}),r&&"Aprobado"===a.revisorStatus&&(0,i.jsxs)(N._2,{onSelect:()=>h(a),disabled:"Aprobada"!==a.preliquidationStatus,children:[(0,i.jsx)(p.A,{className:"mr-2 h-4 w-4"})," Asignar a Digitaci\xf3n"]})]})]})]})}),(0,i.jsxs)(v.Wu,{children:[(0,i.jsx)("div",{className:"flex justify-center items-center mb-4",children:(0,i.jsx)(eg.V,{caseData:a})}),(0,i.jsx)(ej.nD,{type:"single",collapsible:!0,className:"w-full",children:(0,i.jsxs)(ej.As,{value:"item-1",children:[(0,i.jsx)(ej.$m,{children:"Ver Detalles Completos"}),(0,i.jsx)(ej.ub,{children:(0,i.jsxs)("div",{className:"space-y-2 pt-2",children:[(0,i.jsx)(ev,{label:"Ejecutivo",children:a.executive}),(0,i.jsx)(ev,{label:"Aforador",children:a.aforador||"Sin asignar"}),(0,i.jsx)(ev,{label:"Estado Aforador",children:(0,i.jsx)(et.E,{variant:(e=>{switch(e){case"En revisi\xf3n":return"default";case"Incompleto":case"Pendiente":return"destructive";case"En proceso":return"secondary";default:return"outline"}})(a.aforadorStatus),children:a.aforadorStatus||"Pendiente"})}),(0,i.jsx)(ev,{label:"Revisor",children:a.revisorAsignado||"Sin asignar"}),(0,i.jsx)(ev,{label:"Estado Revisor",children:(0,i.jsx)(et.E,{variant:(e=>{switch(e){case"Aprobado":return"default";case"Rechazado":return"destructive";case"Revalidaci\xf3n Solicitada":return"secondary";default:return"outline"}})(a.revisorStatus),children:a.revisorStatus||"Pendiente"})})]})})]})})]})]},a.id)};var eN=s(73457),eb=s(98460),eA=s(67421),ey=s(98053),ew=s(9691),eS=s(76444),eC=s(31120);let eE=w.z.object({comment:w.z.string().min(1,"El comentario no puede estar vac\xedo.")});function eD(e){let{isOpen:a,onClose:s,caseData:t}=e,{user:l}=(0,n.A)(),{toast:d}=(0,D.dj)(),[c,u]=(0,r.useState)(!1),m=(0,A.mN)({resolver:(0,y.u)(eE),defaultValues:{comment:t.aforadorComment||""}}),h=(null==l?void 0:l.role)==="aforador"||(null==l?void 0:l.role)==="admin"||(null==l?void 0:l.role)==="coordinadora"||(null==l?void 0:l.role)==="supervisor",x=async e=>{if(!l||!l.displayName)return void d({title:"Error",description:"Debe estar autenticado.",variant:"destructive"});if(!h)return void d({title:"Permiso Denegado",description:"No tiene permisos para a\xf1adir un comentario.",variant:"destructive"});u(!0);let a=(0,P.H9)(k.db,"AforoCases",t.id),i=(0,P.rJ)(a,"actualizaciones"),r=(0,P.wP)(k.db);try{r.update(a,{aforadorComment:e.comment,aforadorStatusLastUpdate:{by:l.displayName,at:P.Dc.now()}});let n={updatedAt:P.Dc.now(),updatedBy:l.displayName,field:"aforadorComment",oldValue:t.aforadorComment||"",newValue:e.comment};r.set((0,P.H9)(i),n),await r.commit(),d({title:"Observaci\xf3n Guardada",description:"La observaci\xf3n ha sido guardada en la bit\xe1cora del caso."}),s()}catch(e){console.error("Error updating aforador comment:",e),d({title:"Error",description:"No se pudo guardar la observaci\xf3n.",variant:"destructive"})}finally{u(!1)}};return a?(0,i.jsx)(C.lG,{open:a,onOpenChange:s,children:(0,i.jsxs)(C.Cf,{className:"sm:max-w-md",children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{children:"Observaci\xf3n del Aforador"}),(0,i.jsxs)(C.rr,{children:["A\xf1ada o edite una observaci\xf3n para el caso NE: ",(0,i.jsx)("span",{className:"font-bold text-foreground",children:t.ne}),'. Esta observaci\xf3n se usar\xe1 si el estado es "Incompleto".']})]}),(0,i.jsx)(E.lV,{...m,children:(0,i.jsxs)("form",{onSubmit:m.handleSubmit(x),className:"space-y-4 py-4",children:[(0,i.jsx)(E.zB,{control:m.control,name:"comment",render:e=>{var a;let{field:s}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"Observaci\xf3n"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(eC.T,{...s,rows:5,value:null!=(a=s.value)?a:"",disabled:!h||c,placeholder:h?"A\xf1ada la observaci\xf3n aqu\xed...":"Sin observaci\xf3n."})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsxs)(C.Es,{className:"pt-4",children:[(0,i.jsx)(f.$,{type:"button",variant:"outline",onClick:s,children:"Cancelar"}),h&&(0,i.jsxs)(f.$,{type:"submit",disabled:c,children:[c&&(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardar Observaci\xf3n"]})]})]})})]})}):null}let ek=e=>{if(!e)return"N/A";let a=(null==e?void 0:e.toDate)?e.toDate():e;return a instanceof Date&&!isNaN(a.getTime())?(0,en.GP)(a,"dd/MM/yy HH:mm",{locale:eo.es}):"Fecha Inv\xe1lida"},eP=e=>{let{lastUpdate:a,caseCreation:s}=e;if(!a||!a.at)return null;let r=a.at.isEqual(s);return(0,i.jsxs)(ec.m_,{children:[(0,i.jsx)(ec.k$,{asChild:!0,children:(0,i.jsx)(H.A,{className:"h-4 w-4 text-muted-foreground ml-2 cursor-pointer"})}),(0,i.jsxs)(ec.ZI,{children:[(0,i.jsxs)("p",{children:[r?"Registro realizado por":"Modificado por",": ",a.by]}),(0,i.jsxs)("p",{children:["Fecha: ",ek(a.at)]})]})]})};function ez(e){let{cases:a,isLoading:s,error:t,onRefresh:l}=e,{user:d}=(0,n.A)(),{toast:u}=(0,D.dj)(),[m,h]=(0,r.useState)([]),[j,g]=(0,r.useState)({}),[v,b]=(0,r.useState)(new Set),[A,y]=(0,r.useState)([]),[w,E]=(0,r.useState)(null),[B,$]=(0,r.useState)(null),[H,en]=(0,r.useState)(null),[eo,em]=(0,r.useState)(null),[eh,ej]=(0,r.useState)(null),[ev,eC]=(0,r.useState)({isOpen:!1,case:null,type:"aforador"}),[eE,ez]=(0,r.useState)({isOpen:!1}),[eI,eV]=(0,r.useState)({isOpen:!1,caseData:null}),[eO,eR]=(0,r.useState)({isOpen:!1,success:[],skipped:[]}),[eM,eL]=(0,r.useState)(!1),e_=(0,ep.a)();(0,r.useEffect)(()=>{(async()=>{let e=new Map,a=["aforador","coordinadora","supervisor","digitador","agente"].map(e=>(0,P.P)((0,P.rJ)(k.db,"users"),(0,P._M)("role","==",e)));try{(await Promise.all(a.map(e=>(0,P.GG)(e)))).forEach(a=>{a.forEach(a=>{let s={uid:a.id,...a.data()};!e.has(s.uid)&&s.displayName&&e.set(s.uid,s)})}),h(Array.from(e.values()))}catch(e){console.error("Error fetching users",e)}})()},[]);let eB=(0,r.useCallback)(async function(e,s,i){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!d||!d.displayName)return void u({title:"No autenticado",description:"Debe iniciar sesi\xf3n para guardar cambios."});let t=a.find(a=>a.id===e);if(!t)return;let n=t[s];if(JSON.stringify(n)===JSON.stringify(i))return;g(a=>({...a,[e]:!0}));let o=(0,P.H9)(k.db,"AforoCases",e),c=(0,P.rJ)(o,"actualizaciones"),m=(0,P.wP)(k.db);try{let e={[s]:i},a=P.Dc.now(),t={by:d.displayName,at:a},h={aforadorStatus:"aforadorStatusLastUpdate",revisorStatus:"revisorStatusLastUpdate",digitacionStatus:"digitacionStatusLastUpdate",preliquidationStatus:"preliquidationStatusLastUpdate",incidentStatus:"incidentStatusLastUpdate",revisorAsignado:"revisorAsignadoLastUpdate",digitadorAsignado:"digitadorAsignadoLastUpdate",aforador:"aforadorStatusLastUpdate"};h[s]&&(e[h[s]]=t),m.update(o,e);let x={updatedAt:a,updatedBy:d.displayName,field:s,oldValue:null!=n?n:null,newValue:i};m.set((0,P.H9)(c),x),await m.commit(),r||u({title:"Guardado Autom\xe1tico",description:"El campo se ha actualizado."}),l()}catch(e){console.error("Error updating case:",e),u({title:"Error",description:"No se pudo guardar el cambio.",variant:"destructive"})}finally{g(a=>({...a,[e]:!1}))}},[d,a,u,l]),e$=(0,r.useCallback)(async e=>{if(!d||!d.displayName)return;g(a=>({...a,[e]:!0}));let a=(0,P.H9)(k.db,"AforoCases",e),s=(0,P.rJ)(a,"actualizaciones");try{let e=(0,P.wP)(k.db);e.update(a,{isPatternValidated:!0});let i={updatedAt:P.Dc.now(),updatedBy:d.displayName,field:"isPatternValidated",oldValue:!1,newValue:!0,comment:"".concat(d.displayName," valid\xf3 el patr\xf3n de declaraci\xf3n.")};e.set((0,P.H9)(s),i),await e.commit(),u({title:"Patr\xf3n Validado",description:"Ahora puede asignar un aforador."}),l()}catch(e){console.error("Error validating pattern:",e),u({title:"Error",description:"No se pudo validar el patr\xf3n.",variant:"destructive"})}finally{g(a=>({...a,[e]:!1}))}},[d,u,l]),eU=(0,r.useCallback)((e,a,s)=>{eB(e,"aforador"===s?"aforador":"revisorAsignado",a),"aforador"===s&&eB(e,"assignmentDate",P.Dc.now())},[eB]),eH=async()=>{if(!d||!d.displayName||0===A.length)return;setIsLoading(!0);let e=(0,P.wP)(k.db);A.forEach(a=>{let s=(0,P.H9)(k.db,"AforoCases",a),i=(0,P.rJ)(s,"actualizaciones"),r={updatedAt:P.Dc.now(),updatedBy:d.displayName,field:"document_update",oldValue:null,newValue:"worksheet_received",comment:"Se reciben hojas fisicas de casos"};e.set((0,P.H9)(i),r),e.update(s,{acuseDeRecibido:!0})});try{await e.commit(),u({title:"Acuse Masivo Exitoso",description:"".concat(A.length," caso(s) han sido actualizados en la bit\xe1cora.")}),y([]),l()}catch(e){console.error("Error with bulk acknowledge:",e),u({title:"Error",description:"No se pudo registrar el acuse masivo.",variant:"destructive"})}finally{setIsLoading(!1)}},eJ=async e=>{if(!d||!d.displayName)return;let a=(0,P.H9)(k.db,"AforoCases",e),s=(0,P.rJ)(a,"actualizaciones"),i=(0,P.wP)(k.db);try{let e={updatedAt:P.Dc.now(),updatedBy:d.displayName,field:"document_update",oldValue:null,newValue:"worksheet_received",comment:"El supervisor ".concat(d.displayName," confirma la recepci\xf3n de la hoja de trabajo.")};i.set((0,P.H9)(s),e),i.update(a,{acuseDeRecibido:!0}),await i.commit(),u({title:"Acuse Registrado",description:"Se ha registrado la recepci\xf3n de la hoja de trabajo en la bit\xe1cora."}),l()}catch(e){console.error("Error acknowledging worksheet:",e),u({title:"Error",description:"No se pudo registrar el acuse.",variant:"destructive"})}},eT=async e=>{if(!d||!d.displayName)return;let a=(0,P.H9)(k.db,"AforoCases",e.id),s=(0,P.rJ)(a,"actualizaciones"),i=(0,P.wP)(k.db);try{i.update(a,{revisorStatus:"Revalidaci\xf3n Solicitada"});let r={updatedAt:P.Dc.now(),updatedBy:d.displayName,field:"status_change",oldValue:e.revisorStatus,newValue:"Revalidaci\xf3n Solicitada",comment:"El aforador ".concat(d.displayName," ha solicitado una revalidaci\xf3n del caso.")};i.set((0,P.H9)(s),r),await i.commit(),u({title:"Revalidaci\xf3n Solicitada",description:"Se ha notificado al revisor para una nueva validaci\xf3n."}),l()}catch(e){u({title:"Error",description:"No se pudo solicitar la revalidaci\xf3n.",variant:"destructive"})}},eG=async e=>{if(!d||!d.displayName)return;let a=(0,P.H9)(k.db,"AforoCases",e.id),s=(0,P.rJ)(a,"actualizaciones"),i=(0,P.wP)(k.db);try{i.update(a,{digitacionStatus:"Pendiente de Digitaci\xf3n"});let r={updatedAt:P.Dc.now(),updatedBy:d.displayName,field:"status_change",oldValue:e.digitacionStatus,newValue:"Pendiente de Digitaci\xf3n",comment:"Caso listo y enviado a digitaci\xf3n."};i.set((0,P.H9)(s),r),await i.commit(),u({title:"Enviado a Digitaci\xf3n",description:"El caso est\xe1 listo para que el digitador lo procese."}),l()}catch(e){u({title:"Error",description:"No se pudo enviar a digitaci\xf3n.",variant:"destructive"})}},eq=async(e,s)=>{if(!d||!d.displayName||0===A.length)return;setIsLoading(!0);let i=(0,P.wP)(k.db);A.forEach(r=>{let t=(0,P.H9)(k.db,"AforoCases",r),n=(0,P.rJ)(t,"actualizaciones"),l=a.find(e=>e.id===r);if(l){let a="aforador"===e?"aforador":"revisor"===e?"revisorAsignado":e,r={[a]:s},o=P.Dc.now(),c={by:d.displayName,at:o},u={revisorAsignado:"revisorAsignadoLastUpdate",aforador:"aforadorStatusLastUpdate",digitadorAsignado:"digitadorAsignadoLastUpdate",aforadorStatus:"aforadorStatusLastUpdate",revisorStatus:"revisorStatusLastUpdate",preliquidationStatus:"preliquidationStatusLastUpdate",digitacionStatus:"digitacionStatusLastUpdate"};u[a]&&(r[u[a]]=c),"aforador"===a&&(r.assignmentDate=o),i.update(t,r);let m={updatedAt:o,updatedBy:d.displayName,field:a,oldValue:l[a]||null,newValue:s,comment:"Acci\xf3n masiva: ".concat(a," actualizado a ").concat(s,".")};i.set((0,P.H9)(n),m)}});try{await i.commit(),u({title:"Acci\xf3n Masiva Exitosa",description:"".concat(A.length," casos han sido actualizados.")}),y([]),l()}catch(e){console.error("Error with bulk action:",e),u({title:"Error",description:"No se pudo completar la acci\xf3n masiva.",variant:"destructive"})}finally{setIsLoading(!1),eC({isOpen:!1,case:null,type:"aforador"}),ez({isOpen:!1})}},eF=async()=>{if(!d||!d.displayName||0===A.length)return;setIsLoading(!0);let e=(0,P.wP)(k.db),s=[],i=[],r="Pendiente de Digitaci\xf3n";for(let t of A){let n=a.find(e=>e.id===t);if(n&&"Aprobado"===n.revisorStatus&&"Aprobada"===n.preliquidationStatus&&(!n.digitacionStatus||"N/A"===n.digitacionStatus||"Pendiente"===n.digitacionStatus)){let a=(0,P.H9)(k.db,"AforoCases",t),i=(0,P.rJ)(a,"actualizaciones");e.update(a,{digitacionStatus:r});let l={updatedAt:P.Dc.now(),updatedBy:d.displayName,field:"digitacionStatus",oldValue:n.digitacionStatus||"N/A",newValue:r,comment:"Env\xedo masivo a digitaci\xf3n."};e.set((0,P.H9)(i),l),s.push(n.ne)}else n&&i.push(n.ne)}try{s.length>0?(await e.commit(),u({title:"Env\xedo a Digitaci\xf3n Procesado",description:"".concat(s.length," caso(s) enviados. ").concat(i.length," omitidos.")})):u({title:"No se enviaron casos",description:"Ninguno de los casos seleccionados cumpl\xeda los requisitos para ser enviado a digitaci\xf3n.",variant:"default"}),eR({isOpen:!0,success:s,skipped:i}),y([]),l()}catch(e){console.error("Error bulk sending to digitization:",e),u({title:"Error",description:"No se pudieron enviar los casos a digitaci\xf3n.",variant:"destructive"})}finally{setIsLoading(!1)}},[eZ,eW]=(0,r.useState)(""),eQ=async()=>{if("192438"!==eZ)return void u({title:"PIN Incorrecto",variant:"destructive"});if(0===A.length)return;setIsLoading(!0);let e=(0,P.wP)(k.db);for(let s of A){let i=a.find(e=>e.id===s);if(i&&i.worksheetId){let a=(0,P.H9)(k.db,"worksheets",i.worksheetId);e.update(a,{worksheetType:"corporate_report"});let r=(0,P.H9)(k.db,"AforoCases",s),t=(0,P.rJ)(r,"actualizaciones"),n={updatedAt:P.Dc.now(),updatedBy:(null==d?void 0:d.displayName)||"Sistema",field:"worksheetType",oldValue:"hoja_de_trabajo",newValue:"corporate_report",comment:"Caso reclasificado a Reporte Corporativo via Deathkey."};e.set((0,P.H9)(t),n)}}try{await e.commit(),u({title:"\xc9xito",description:"".concat(A.length," casos han sido reclasificados.")}),y([]),eL(!1),eW(""),l()}catch(e){console.error("Error with Deathkey action:",e),u({title:"Error",description:"No se pudieron reclasificar los casos.",variant:"destructive"})}finally{setIsLoading(!1)}},eX=e=>E(e),eY=e=>$(e),eK=e=>en(e),e0=e=>{$(e)},e4=(e,a)=>eC({isOpen:!0,case:e,type:a}),e2=async e=>{if(!e.worksheetId)return void u({title:"Error",description:"Este caso no tiene una hoja de trabajo asociada.",variant:"destructive"});let a=(0,P.H9)(k.db,"worksheets",e.worksheetId),s=await (0,P.x7)(a);s.exists()?em({id:s.id,...s.data()}):u({title:"Error",description:"No se pudo encontrar la hoja de trabajo.",variant:"destructive"})};if(s)return(0,i.jsxs)("div",{className:"flex justify-center items-center py-10",children:[(0,i.jsx)(o.A,{className:"h-8 w-8 animate-spin text-primary"}),(0,i.jsx)("p",{className:"ml-3 text-muted-foreground",children:"Cargando registros de aforo..."})]});if(t)return(0,i.jsxs)("div",{className:"text-center py-10 px-6 bg-destructive/10 rounded-lg",children:[(0,i.jsx)(J.A,{className:"mx-auto h-12 w-12 text-destructive"}),(0,i.jsx)("h3",{className:"mt-4 text-lg font-medium text-destructive",children:"Error al Cargar los Datos"}),(0,i.jsx)("p",{className:"mt-1 text-sm text-destructive/80 whitespace-pre-wrap",children:t})]});if(0===a.length)return(0,i.jsxs)("div",{className:"text-center py-10 px-6 bg-secondary/30 rounded-lg",children:[(0,i.jsx)(T.A,{className:"mx-auto h-12 w-12 text-muted-foreground"}),(0,i.jsx)("h3",{className:"mt-4 text-lg font-medium text-foreground",children:"No hay casos pendientes"}),(0,i.jsx)("p",{className:"mt-1 text-muted-foreground",children:"No hay casos de aforo que cumplan con los filtros actuales."})]});let e1=(null==d?void 0:d.role)==="admin"||(null==d?void 0:d.role)==="coordinadora"||(null==d?void 0:d.role)==="supervisor";return(null==d||d.role,e_)?(0,i.jsx)("div",{className:"space-y-4",children:a.map(e=>(0,i.jsx)(ef,{caseItem:e,savingState:j,canEditFields:e1,handleAutoSave:eB,handleValidatePattern:e$,openAssignmentModal:e4,openHistoryModal:eX,openIncidentModal:eK,openAforadorCommentModal:eY,openObservationModal:e0,handleRequestRevalidation:eT,handleAssignToDigitization:eG,handleViewWorksheet:e2,setSelectedIncidentForDetails:ej},e.id))}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ec.Bc,{children:(0,i.jsxs)("div",{className:"overflow-x-auto table-container rounded-lg border",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 p-2",children:[(0,i.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>{b(new Set)},className:"h-8 w-8",children:(0,i.jsx)(z.A,{className:"h-4 w-4"})}),e1&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(f.$,{variant:"outline",size:"sm",onClick:eH,disabled:0===A.length,children:["Enviar Acuse (",A.length,")"]}),(0,i.jsxs)(f.$,{variant:"outline",size:"sm",onClick:()=>eC({isOpen:!0,case:null,type:"bulk-aforador"}),disabled:0===A.length,children:["Asignar Aforador (",A.length,")"]}),(0,i.jsxs)(f.$,{variant:"outline",size:"sm",onClick:()=>eC({isOpen:!0,case:null,type:"bulk-revisor"}),disabled:0===A.length,children:["Asignar Revisor (",A.length,")"]}),(0,i.jsxs)(f.$,{variant:"outline",size:"sm",onClick:()=>ez({isOpen:!0}),disabled:0===A.length,children:["Asignar Estatus (",A.length,")"]}),(0,i.jsxs)(f.$,{variant:"secondary",size:"sm",onClick:eF,disabled:0===A.length,children:["Enviar a Digitaci\xf3n (",A.length,")"]}),(0,i.jsxs)(f.$,{variant:"destructive",size:"sm",onClick:()=>eL(!0),disabled:0===A.length,children:["Deathkey Masivo (",A.length,")"]})]})]}),(0,i.jsxs)(U.XI,{children:[(0,i.jsx)(U.A0,{children:(0,i.jsxs)(U.Hj,{children:[(0,i.jsx)(U.nd,{className:"w-12",children:(0,i.jsx)(eN.S,{checked:A.length>0&&A.length===a.length,onCheckedChange:()=>{A.length===a.length?y([]):y(a.map(e=>e.id))}})}),(0,i.jsx)(U.nd,{className:"w-12"}),(0,i.jsx)(U.nd,{children:"Acciones"}),(0,i.jsx)(U.nd,{children:"NE"}),(0,i.jsx)(U.nd,{children:"Insignias"}),(0,i.jsx)(U.nd,{children:"Ejecutivo"}),(0,i.jsx)(U.nd,{children:"Consignatario"}),(0,i.jsx)(U.nd,{children:"Aforador"}),(0,i.jsx)(U.nd,{children:"Fecha Asignaci\xf3n"}),(0,i.jsx)(U.nd,{children:"Estatus Aforador"}),(0,i.jsx)(U.nd,{children:"Revisor"}),(0,i.jsx)(U.nd,{children:"Estatus Revisor"})]})}),(0,i.jsx)(U.BF,{children:a.map(e=>{var a,s,t;let n=v.has(e.id),l=e.resaDueDate?(0,el.c)(e.resaDueDate.toDate(),new Date):null,o=(0,_.cn)(j[e.id]&&"bg-amber-100",null!==l&&l<-15?"bg-red-200 hover:bg-red-200/80":e.incidentReported?"bg-red-100 hover:bg-red-100/80":"Pendiente "===e.aforadorStatus?"bg-red-50 hover:bg-red-100/60":""),u=e1||(null==d?void 0:d.role)==="aforador"&&(null==d?void 0:d.displayName)===e.aforador,m=(null==d?void 0:d.role)==="aforador"||e1,h=!0===e.isPatternValidated,g="Rechazado"===e.revisorStatus,w=!0===e.acuseDeRecibido;return(0,i.jsxs)(r.Fragment,{children:[(0,i.jsxs)(U.Hj,{className:o,"data-state":A.includes(e.id)?"selected":void 0,children:[(0,i.jsx)(U.nA,{children:(0,i.jsx)(eN.S,{checked:A.includes(e.id),onCheckedChange:()=>{var a;return a=e.id,void y(e=>e.includes(a)?e.filter(e=>e!==a):[...e,a])}})}),(0,i.jsx)(U.nA,{children:m&&(0,i.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>{var a;return a=e.id,void b(e=>{let s=new Set(e);return s.has(a)?s.delete(a):s.add(a),s})},className:"h-8 w-8",children:n?(0,i.jsx)(c.A,{className:"h-4 w-4"}):(0,i.jsx)(G.A,{className:"h-4 w-4"})})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)(N.rI,{children:[(0,i.jsx)(N.ty,{asChild:!0,children:(0,i.jsxs)(f.$,{variant:"ghost",className:"h-8 w-8 p-0",children:[(0,i.jsx)("span",{className:"sr-only",children:"Abrir men\xfa"}),(0,i.jsx)(q.A,{className:"h-4 w-4"})]})}),(0,i.jsxs)(N.SQ,{align:"end",children:[e.worksheetId&&(0,i.jsxs)(N._2,{onSelect:()=>e2(e),children:[(0,i.jsx)(F.A,{className:"mr-2 h-4 w-4"})," Ver Hoja de Trabajo"]}),(0,i.jsxs)(N._2,{onSelect:()=>(e=>{let a="/database?ne=".concat(encodeURIComponent(e));window.open(a,"_blank")})(e.ne),children:[(0,i.jsx)(x.A,{className:"mr-2 h-4 w-4"})," Buscar Previo"]}),(0,i.jsxs)(N._2,{onSelect:()=>e0(e),children:[(0,i.jsx)(Z.A,{className:"mr-2 h-4 w-4"})," Observaci\xf3n"]}),(0,i.jsxs)(N._2,{onSelect:()=>eX(e),children:[(0,i.jsx)(W.A,{className:"mr-2 h-4 w-4"})," Ver Bit\xe1cora"]}),u&&(0,i.jsxs)(N._2,{onSelect:()=>eK(e),children:[(0,i.jsx)(J.A,{className:"mr-2 h-4 w-4 text-amber-600"})," Reportar Incidencia"]}),e.incidentReported&&(0,i.jsxs)(N._2,{onSelect:()=>ej(e),children:[(0,i.jsx)(Q.A,{className:"mr-2 h-4 w-4"})," Ver Incidencia"]}),((null==d?void 0:d.role)==="aforador"||(null==d?void 0:d.role)==="admin")&&"Rechazado"===e.revisorStatus&&(0,i.jsxs)(N._2,{onSelect:()=>eT(e),children:[(0,i.jsx)(X.A,{className:"mr-2 h-4 w-4"})," Solicitar Revalidaci\xf3n"]}),e1&&"Aprobado"===e.revisorStatus&&(0,i.jsxs)(N._2,{onSelect:()=>eG(e),disabled:"Aprobada"!==e.preliquidationStatus,children:[(0,i.jsx)(p.A,{className:"mr-2 h-4 w-4"})," Asignar a Digitaci\xf3n"]}),e1&&(0,i.jsxs)(N._2,{onSelect:()=>eJ(e.id),children:[(0,i.jsx)(Y.A,{className:"mr-2 h-4 w-4 text-blue-600"})," Acuse de Hoja"]})]})]})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"font-medium",children:e.ne}),e.incidentReported&&e1&&(0,i.jsxs)(ec.m_,{children:[(0,i.jsx)(ec.k$,{asChild:!0,children:(0,i.jsx)(f.$,{variant:"destructive",size:"icon",className:"h-7 w-7",onClick:()=>eV({isOpen:!0,caseData:e}),children:(0,i.jsx)(K.A,{className:"h-4 w-4"})})}),(0,i.jsx)(ec.ZI,{children:(0,i.jsx)("p",{children:"Asignar Involucrados"})})]})]})}),(0,i.jsx)(U.nA,{children:(0,i.jsx)(eg.V,{caseData:{...e,acuseDeRecibido:w}})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-1",children:[(0,i.jsx)("span",{children:e.executive}),(0,i.jsx)(eP,{lastUpdate:{by:e.executive,at:e.createdAt},caseCreation:e.createdAt})]})}),(0,i.jsx)(U.nA,{children:e.consignee}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{children:e.aforador||"Sin asignar"}),(0,i.jsx)(eP,{lastUpdate:e.aforadorStatusLastUpdate,caseCreation:e.createdAt})]})}),(0,i.jsx)(U.nA,{children:ek(e.assignmentDate)}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-1",children:[(0,i.jsx)(ec.Bc,{children:(0,i.jsxs)(ec.m_,{children:[(0,i.jsx)(ec.k$,{asChild:!0,children:(0,i.jsx)("div",{className:"w-full",children:(0,i.jsxs)(O.l6,{value:null!=(t=e.aforadorStatus)?t:"",onValueChange:a=>eB(e.id,"aforadorStatus",a),disabled:!u||!e.aforador,children:[(0,i.jsx)(O.bq,{className:"w-[180px]",children:(0,i.jsx)(O.yv,{placeholder:"Seleccionar estado..."})}),(0,i.jsxs)(O.gC,{children:[(0,i.jsx)(O.eb,{value:"Pendiente ",children:"Pendiente "}),(0,i.jsx)(O.eb,{value:"En proceso",children:"En proceso"}),(0,i.jsx)(O.eb,{value:"Incompleto",children:"Incompleto"}),(0,i.jsx)(O.eb,{value:"En revisi\xf3n",children:"En revisi\xf3n"})]})]})})}),!e.aforador&&(0,i.jsx)(ec.ZI,{children:(0,i.jsx)("p",{children:"Debe asignar un aforador primero."})})]})}),"Incompleto"===e.aforadorStatus&&(0,i.jsxs)(ec.m_,{children:[(0,i.jsx)(ec.k$,{asChild:!0,children:(0,i.jsx)(f.$,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>eY(e),children:(0,i.jsx)(ee.A,{className:"h-4 w-4"})})}),(0,i.jsx)(ec.ZI,{children:(0,i.jsx)("p",{children:"Ver/Editar motivo"})})]}),(0,i.jsx)(eP,{lastUpdate:e.aforadorStatusLastUpdate,caseCreation:e.createdAt})]})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{children:e.revisorAsignado||"Sin asignar"}),(0,i.jsx)(eP,{lastUpdate:e.revisorAsignadoLastUpdate,caseCreation:e.createdAt})]})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)(et.E,{variant:(e=>{switch(e){case"Aprobado":return"default";case"Rechazado":return"destructive";case"Revalidaci\xf3n Solicitada":return"secondary";default:return"outline"}})(e.revisorStatus),children:e.revisorStatus||"Pendiente"}),(0,i.jsx)(eP,{lastUpdate:e.revisorStatusLastUpdate,caseCreation:e.createdAt})]})})]}),n&&m&&(0,i.jsx)(U.Hj,{className:"bg-muted/30 hover:bg-muted/40",children:(0,i.jsx)(U.nA,{colSpan:13,className:"p-0",children:(0,i.jsxs)("div",{className:"p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,i.jsxs)("div",{className:"flex items-end gap-2",children:[(0,i.jsxs)("div",{className:"flex-grow",children:[(0,i.jsx)("label",{className:"text-xs font-medium text-muted-foreground",children:"Modelo (Patr\xf3n)"}),(0,i.jsxs)(M.AM,{children:[(0,i.jsx)(M.Wv,{asChild:!0,children:(0,i.jsxs)(f.$,{variant:"outline",role:"combobox",className:(0,_.cn)("w-full justify-between",!e.declarationPattern&&"text-muted-foreground"),disabled:!u||h&&!g,children:[e.declarationPattern?null==(a=L.h7.find(a=>a.value===e.declarationPattern))?void 0:a.value:"Seleccionar...",(0,i.jsx)(z.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,i.jsx)(M.hl,{className:"w-[--radix-popover-trigger-width] p-0",children:(0,i.jsxs)(R.uB,{children:[(0,i.jsx)(R.G7,{placeholder:"Buscar por c\xf3digo..."}),(0,i.jsxs)(R.oI,{children:[(0,i.jsx)(R.xL,{children:"No se encontr\xf3 el modelo."}),(0,i.jsx)(R.L$,{children:L.h7.map(a=>(0,i.jsxs)(R.h_,{value:a.value,onSelect:()=>{var s;eB(e.id,"declarationPattern",a.value,!0),null==(s=document.activeElement)||s.blur()},children:[(0,i.jsx)(I.A,{className:(0,_.cn)("mr-2 h-4 w-4",a.value===e.declarationPattern?"opacity-100":"opacity-0")}),(0,i.jsxs)("div",{className:"flex flex-col",children:[(0,i.jsx)("span",{className:"font-bold",children:a.value}),(0,i.jsx)("span",{className:"text-xs text-muted-foreground",children:a.label})]})]},a.value))})]})]})})]})]}),(0,i.jsxs)(f.$,{onClick:()=>e$(e.id),disabled:h||!e.declarationPattern||j[e.id],children:[(0,i.jsx)(ea.A,{className:"mr-2 h-4 w-4"})," Validar"]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"text-xs font-medium text-muted-foreground",children:"Mercanc\xeda"}),(0,i.jsx)(S.p,{defaultValue:e.merchandise,onBlur:a=>eB(e.id,"merchandise",a.target.value),disabled:!u})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"text-xs font-medium text-muted-foreground",children:"Asignar Aforador"}),(0,i.jsx)(ec.m_,{children:(0,i.jsx)(ec.k$,{asChild:!0,children:(0,i.jsx)("div",{className:"w-full",children:(0,i.jsxs)(f.$,{variant:"outline",onClick:()=>e4(e,"aforador"),disabled:!e1,className:"w-full justify-between",children:[e.aforador||"Asignar...",(0,i.jsx)(es.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})})})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"text-xs font-medium text-muted-foreground",children:"Asignar Revisor"}),(0,i.jsx)(ec.m_,{children:(0,i.jsx)(ec.k$,{asChild:!0,children:(0,i.jsx)("div",{className:"w-full",children:(0,i.jsxs)(f.$,{variant:"outline",onClick:()=>e4(e,"revisor"),disabled:!e1,className:"w-full justify-between",children:[e.revisorAsignado||"Asignar...",(0,i.jsx)(ei.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})})})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"text-xs font-medium text-muted-foreground",children:"Total Posiciones"}),(0,i.jsx)(S.p,{type:"number",defaultValue:e.totalPosiciones,onBlur:a=>eB(e.id,"totalPosiciones",a.target.valueAsNumber),disabled:!u})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"text-xs font-medium text-muted-foreground",children:"Entregado a Aforo"}),(0,i.jsx)(V.I,{date:null==(s=e.entregadoAforoAt)?void 0:s.toDate(),onDateChange:()=>{},disabled:!0})]})]})})})]},e.id)})})]})]})}),w&&(0,i.jsx)(ed.p,{isOpen:!!w,onClose:()=>E(null),caseData:w}),B&&(0,i.jsx)(eD,{isOpen:!!B,onClose:()=>$(null),caseData:B}),H&&(0,i.jsx)(eb.u,{isOpen:!!H,onClose:()=>en(null),caseData:H}),eh&&(0,i.jsx)(eA.h,{caseData:eh,onClose:()=>ej(null)}),eo&&(0,i.jsx)(ew.j,{isOpen:!!eo,onClose:()=>em(null),worksheet:eo}),ev.isOpen&&(0,i.jsx)(eu.a,{isOpen:ev.isOpen,onClose:()=>eC({isOpen:!1,case:null,type:"aforador"}),caseData:ev.case,assignableUsers:ev.type.includes("bulk")?"bulk-aforador"===ev.type?m.filter(e=>"aforador"===e.role||"coordinadora"===e.role||"supervisor"===e.role):m.filter(e=>"agente aduanero"===e.roleTitle||"supervisor"===e.role&&"PSMT"===e.roleTitle):"aforador"===ev.type?m.filter(e=>"aforador"===e.role||"coordinadora"===e.role||"supervisor"===e.role):m.filter(e=>"agente aduanero"===e.roleTitle||"supervisor"===e.role&&"PSMT"===e.roleTitle),onAssign:(e,a)=>ev.type.includes("bulk")?eq(ev.type.split("-")[1],a):eU(e,a,ev.type),title:"Asignar ".concat(ev.type.includes("bulk")?"aforador"===ev.type.split("-")[1]?"Aforador Masivo":"Revisor Masivo":"aforador"===ev.type?"Aforador":"Revisor"),description:ev.case?"Seleccione un usuario para asignar al caso NE: ".concat(ev.case.ne):"Seleccione un usuario para asignar a los ".concat(A.length," casos seleccionados.")}),(0,i.jsx)(C.lG,{open:eE.isOpen,onOpenChange:()=>ez({isOpen:!1,caseData:void 0}),children:(0,i.jsxs)(C.Cf,{children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{children:"Asignar Estatus de Aforador Masivo"}),(0,i.jsxs)(C.rr,{children:["Seleccione el estatus a aplicar a los ",A.length," casos seleccionados."]})]}),(0,i.jsxs)(O.l6,{onValueChange:e=>{eq("aforadorStatus",e)},children:[(0,i.jsx)(O.bq,{children:(0,i.jsx)(O.yv,{placeholder:"Seleccionar estatus..."})}),(0,i.jsxs)(O.gC,{children:[(0,i.jsx)(O.eb,{value:"Pendiente ",children:"Pendiente "}),(0,i.jsx)(O.eb,{value:"En proceso",children:"En proceso"}),(0,i.jsx)(O.eb,{value:"Incompleto",children:"Incompleto"}),(0,i.jsx)(O.eb,{value:"En revisi\xf3n",children:"En revisi\xf3n"})]})]})]})}),eI.isOpen&&eI.caseData&&(0,i.jsx)(ex,{isOpen:eI.isOpen,onClose:()=>eV({isOpen:!1,caseData:null}),caseData:eI.caseData,allUsers:m}),(0,i.jsx)(ey.Lt,{open:eO.isOpen,onOpenChange:e=>eR(a=>({...a,isOpen:e})),children:(0,i.jsxs)(ey.EO,{children:[(0,i.jsxs)(ey.wd,{children:[(0,i.jsx)(C.L3,{children:"Resultado del Env\xedo Masivo"}),(0,i.jsx)(ey.$v,{children:(0,i.jsxs)("div",{className:"space-y-4 max-h-60 overflow-y-auto",children:[eO.success.length>0&&(0,i.jsxs)("div",{children:[(0,i.jsx)("p",{className:"font-semibold text-green-600",children:"Casos enviados a digitaci\xf3n exitosamente:"}),(0,i.jsx)("ul",{className:"list-disc list-inside text-sm text-muted-foreground",children:eO.success.map(e=>(0,i.jsx)("li",{children:e},e))})]}),eO.skipped.length>0&&(0,i.jsxs)("div",{children:[(0,i.jsx)("p",{className:"font-semibold text-amber-600",children:"Casos omitidos (no cumpl\xedan los criterios):"}),(0,i.jsx)("ul",{className:"list-disc list-inside text-sm text-muted-foreground",children:eO.skipped.map(e=>(0,i.jsx)("li",{children:e},e))})]})]})})]}),(0,i.jsx)(ey.ck,{children:(0,i.jsx)(ey.Rx,{onClick:()=>eR({isOpen:!1,success:[],skipped:[]}),children:"Entendido"})})]})}),(0,i.jsx)(C.lG,{open:eM,onOpenChange:eL,children:(0,i.jsxs)(C.Cf,{children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{children:'Confirmar Acci\xf3n "Deathkey"'}),(0,i.jsxs)(C.rr,{children:["Esta acci\xf3n reclasificar\xe1 ",A.length,' caso(s) a "Reporte Corporativo", excluy\xe9ndolos de la l\xf3gica de Aforo. Esta acci\xf3n es irreversible. Por favor ingrese el PIN para confirmar.']})]}),(0,i.jsxs)("div",{className:"py-4 space-y-2",children:[(0,i.jsxs)(eS.J,{htmlFor:"pin-input",className:"flex items-center gap-2",children:[(0,i.jsx)(er.A,{}),"PIN de Seguridad"]}),(0,i.jsx)(S.p,{id:"pin-input",type:"password",value:eZ,onChange:e=>eW(e.target.value),placeholder:"Ingrese el PIN de 6 d\xedgitos"})]}),(0,i.jsxs)(C.Es,{children:[(0,i.jsx)(f.$,{variant:"outline",onClick:()=>eL(!1),children:"Cancelar"}),(0,i.jsxs)(f.$,{variant:"destructive",onClick:eQ,disabled:s,children:[s&&(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Confirmar y Ejecutar"]})]})]})})]})}let eI=w.z.object({comment:w.z.string().min(1,"El comentario no puede estar vac\xedo.")});function eV(e){let{isOpen:a,onClose:s,caseData:t}=e,{user:l}=(0,n.A)(),{toast:d}=(0,D.dj)(),[c,u]=(0,r.useState)(!1),m=(0,A.mN)({resolver:(0,y.u)(eI),defaultValues:{comment:t.digitacionComment||""}}),h=(null==l?void 0:l.role)==="digitador"||(null==l?void 0:l.role)==="admin"||(null==l?void 0:l.role)==="coordinadora",x=async e=>{if(!l||!l.displayName)return void d({title:"Error",description:"Debe estar autenticado.",variant:"destructive"});if(!h)return void d({title:"Permiso Denegado",description:"No tiene permisos para a\xf1adir un comentario.",variant:"destructive"});u(!0);let a=(0,P.H9)(k.db,"AforoCases",t.id),i=(0,P.rJ)(a,"actualizaciones");try{await (0,P.mZ)(a,{digitacionComment:e.comment,digitacionStatusLastUpdate:{by:l.displayName,at:P.Dc.now()}});let r={updatedAt:P.Dc.now(),updatedBy:l.displayName,field:"digitacionComment",oldValue:t.digitacionComment||"",newValue:e.comment};await (0,P.gS)(i,r),d({title:"Comentario de Digitaci\xf3n Guardado",description:"La observaci\xf3n ha sido guardada."}),s()}catch(e){console.error("Error updating digitization comment:",e),d({title:"Error",description:"No se pudo guardar el comentario.",variant:"destructive"})}finally{u(!1)}};return a?(0,i.jsx)(C.lG,{open:a,onOpenChange:s,children:(0,i.jsxs)(C.Cf,{className:"sm:max-w-md",children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{children:"Observaci\xf3n de Digitaci\xf3n"}),(0,i.jsxs)(C.rr,{children:["A\xf1ada o edite una observaci\xf3n para el caso NE: ",(0,i.jsx)("span",{className:"font-bold text-foreground",children:t.ne})]})]}),(0,i.jsx)(E.lV,{...m,children:(0,i.jsxs)("form",{onSubmit:m.handleSubmit(x),className:"space-y-4 py-4",children:[(0,i.jsx)(E.zB,{control:m.control,name:"comment",render:e=>{var a;let{field:s}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"Observaci\xf3n"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(eC.T,{...s,rows:5,value:null!=(a=s.value)?a:"",disabled:!h||c,placeholder:h?"A\xf1ada la observaci\xf3n aqu\xed...":"Sin observaci\xf3n."})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsxs)(C.Es,{className:"pt-4",children:[(0,i.jsx)(f.$,{type:"button",variant:"outline",onClick:s,children:"Cancelar"}),h&&(0,i.jsxs)(f.$,{type:"submit",disabled:c,children:[c&&(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardar Observaci\xf3n"]})]})]})})]})}):null}var eO=s(73180);let eR=w.z.object({declaracionAduanera:w.z.string().min(1,"El n\xfamero de declaraci\xf3n es requerido.")});function eM(e){let{isOpen:a,onClose:s,caseData:t}=e,{user:l}=(0,n.A)(),{toast:d}=(0,D.dj)(),[c,u]=(0,r.useState)(!1),m=(0,A.mN)({resolver:(0,y.u)(eR),defaultValues:{declaracionAduanera:t.declaracionAduanera||""}}),h=(null==l?void 0:l.role)==="digitador"||(null==l?void 0:l.role)==="admin"||(null==l?void 0:l.role)==="coordinadora"||(null==l?void 0:l.roleTitle)==="supervisor",x=async e=>{if(!l||!l.displayName)return void d({title:"Error",description:"Debe estar autenticado.",variant:"destructive"});if(!h)return void d({title:"Permiso Denegado",description:"No tiene permisos para completar este tr\xe1mite.",variant:"destructive"});u(!0);let a=(0,P.H9)(k.db,"AforoCases",t.id),i=(0,P.rJ)(a,"actualizaciones"),r="Tr\xe1mite Completo";try{await (0,P.mZ)(a,{declaracionAduanera:e.declaracionAduanera,digitacionStatus:r,digitacionStatusLastUpdate:{by:l.displayName,at:P.Dc.now()}});let n={updatedAt:P.Dc.now(),updatedBy:l.displayName,field:"digitacionStatus",oldValue:t.digitacionStatus||"Almacenado",newValue:r,comment:"Tr\xe1mite completado con declaraci\xf3n No. ".concat(e.declaracionAduanera)};await (0,P.gS)(i,n),d({title:"Tr\xe1mite Completo",description:"El caso NE ".concat(t.ne," ha sido marcado como completado.")}),s()}catch(e){console.error("Error completing digitization:",e),d({title:"Error",description:"No se pudo completar el tr\xe1mite.",variant:"destructive"})}finally{u(!1)}};return a?(0,i.jsx)(C.lG,{open:a,onOpenChange:s,children:(0,i.jsxs)(C.Cf,{className:"sm:max-w-md",children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{children:"Completar Tr\xe1mite de Digitaci\xf3n"}),(0,i.jsxs)(C.rr,{children:["Ingrese el n\xfamero de declaraci\xf3n aduanera para finalizar el caso NE: ",(0,i.jsx)("span",{className:"font-bold text-foreground",children:t.ne}),"."]})]}),(0,i.jsx)(E.lV,{...m,children:(0,i.jsxs)("form",{onSubmit:m.handleSubmit(x),className:"space-y-4 py-4",children:[(0,i.jsx)(E.zB,{control:m.control,name:"declaracionAduanera",render:e=>{let{field:a}=e;return(0,i.jsxs)(E.eI,{children:[(0,i.jsx)(E.lR,{children:"N\xfamero de Declaraci\xf3n Aduanera"}),(0,i.jsx)(E.MJ,{children:(0,i.jsx)(S.p,{...a,disabled:!h||c,placeholder:"Ingrese el n\xfamero..."})}),(0,i.jsx)(E.C5,{})]})}}),(0,i.jsxs)(C.Es,{className:"pt-4",children:[(0,i.jsx)(f.$,{type:"button",variant:"outline",onClick:s,children:"Cancelar"}),h&&(0,i.jsxs)(f.$,{type:"submit",variant:"destructive",disabled:c,children:[c?(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}):(0,i.jsx)(eO.A,{className:"mr-2 h-4 w-4"}),"Guardar y Completar"]})]})]})})]})}):null}let eL=e=>{let{label:a,children:s}=e;return(0,i.jsxs)("div",{className:"flex justify-between items-center py-2 border-b border-border/50",children:[(0,i.jsx)("p",{className:"text-sm font-medium text-muted-foreground",children:a}),(0,i.jsx)("div",{className:"text-sm text-right text-foreground",children:s})]})},e_=e=>{var a;let{caseItem:s,canEdit:r,isDigitador:t,savingState:n,handleStatusChange:l,handleAutoSave:o,openCommentModal:d,openHistoryModal:c,setSelectedCaseForAssignment:u}=e,m="Tr\xe1mite Completo"===s.digitacionStatus,h="Pendiente"===s.digitacionStatus?"Pendiente de Digitaci\xf3n":s.digitacionStatus;return(0,i.jsxs)(v.Zp,{className:"w-full",children:[(0,i.jsx)(v.aR,{children:(0,i.jsxs)("div",{className:"flex justify-between items-start",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)(v.ZB,{className:"font-bold text-lg text-primary",children:s.ne}),(0,i.jsx)("p",{className:"text-sm text-muted-foreground truncate max-w-[200px]",children:s.consignee})]}),(0,i.jsxs)(N.rI,{children:[(0,i.jsx)(N.ty,{asChild:!0,children:(0,i.jsxs)(f.$,{variant:"ghost",className:"h-8 w-8 p-0",children:[(0,i.jsx)("span",{className:"sr-only",children:"Abrir"}),(0,i.jsx)(q.A,{className:"h-5 w-5"})]})}),(0,i.jsxs)(N.SQ,{align:"end",children:[(0,i.jsxs)(N._2,{onSelect:()=>d(s),children:[(0,i.jsx)(ee.A,{className:"mr-2 h-4 w-4"})," Ver/Editar Observaci\xf3n"]}),(0,i.jsxs)(N._2,{onSelect:()=>c(s),children:[(0,i.jsx)(W.A,{className:"mr-2 h-4 w-4"})," Ver Bit\xe1cora"]})]})]})]})}),(0,i.jsxs)(v.Wu,{className:"space-y-4",children:[(0,i.jsx)(eL,{label:"Ejecutivo",children:s.executive}),(0,i.jsx)(eL,{label:"Digitador Asignado",children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{children:s.digitadorAsignado||"Sin asignar"}),r&&!m&&(0,i.jsx)(f.$,{variant:"outline",size:"sm",onClick:()=>u(s),children:s.digitadorAsignado?"Cambiar":"Asignar"})]})}),(0,i.jsxs)("div",{className:"py-2",children:[(0,i.jsx)("p",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Estado Digitaci\xf3n"}),(0,i.jsxs)(O.l6,{value:null!=h?h:"",onValueChange:e=>l(s.id,e),disabled:!t&&!r||m,children:[(0,i.jsx)(O.bq,{children:(0,i.jsx)(O.yv,{})}),(0,i.jsxs)(O.gC,{children:[(0,i.jsx)(O.eb,{value:"Pendiente de Digitaci\xf3n",children:"Pendiente de Digitaci\xf3n"}),(0,i.jsx)(O.eb,{value:"En Proceso",children:"En Proceso"}),(0,i.jsx)(O.eb,{value:"Almacenado",children:"Almacenado"}),(0,i.jsx)(O.eb,{value:"Completar Tr\xe1mite",children:"Completar Tr\xe1mite"})]})]})]}),(0,i.jsxs)("div",{className:"py-2",children:[(0,i.jsx)("p",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Declaraci\xf3n Aduanera"}),m?(0,i.jsx)(et.E,{variant:"default",children:s.declaracionAduanera}):(0,i.jsx)(S.p,{placeholder:"Ingrese No. Declaraci\xf3n",defaultValue:null!=(a=s.declaracionAduanera)?a:"",onBlur:e=>o(s.id,"declaracionAduanera",e.target.value),disabled:!t&&!r})]})]})]},s.id)},eB=e=>{let{lastUpdate:a,caseCreation:s}=e;if(!a||!a.at)return null;let r=a.at.isEqual(s);return(0,i.jsxs)(ec.m_,{children:[(0,i.jsx)(ec.k$,{asChild:!0,children:(0,i.jsx)(H.A,{className:"h-4 w-4 text-muted-foreground ml-2 cursor-pointer"})}),(0,i.jsxs)(ec.ZI,{children:[(0,i.jsxs)("p",{children:[r?"Registro realizado por":"Modificado por",": ",a.by]}),(0,i.jsxs)("p",{children:["Fecha: ",(e=>{if(!e)return"N/A";let a=(null==e?void 0:e.toDate)?e.toDate():e;return a instanceof Date&&!isNaN(a.getTime())?(0,en.GP)(a,"dd/MM/yy HH:mm",{locale:eo.es}):"Fecha Inv\xe1lida"})(a.at)]})]})]})};function e$(e){let{cases:a,isLoading:s,error:t,onRefresh:l}=e,{user:d}=(0,n.A)(),{toast:c}=(0,D.dj)(),[u,m]=(0,r.useState)([]),[h,x]=(0,r.useState)({}),[p,j]=(0,r.useState)(null),[g,v]=(0,r.useState)(null),[b,A]=(0,r.useState)(null),[y,w]=(0,r.useState)(null),[E,z]=(0,r.useState)([]),[I,V]=(0,r.useState)({isOpen:!1,caseData:null}),[R,M]=(0,r.useState)({isOpen:!1,case:null,type:"digitador"}),L=(0,ep.a)(),_=(0,r.useCallback)(async function(e,s,i){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!d||!d.displayName)return void c({title:"No autenticado",description:"Debe iniciar sesi\xf3n para guardar cambios."});let t=a.find(a=>a.id===e);if(!t)return;let n=t[s];if(JSON.stringify(n)===JSON.stringify(i))return;x(a=>({...a,[e]:!0}));let o=(0,P.H9)(k.db,"AforoCases",e),u=(0,P.rJ)(o,"actualizaciones"),m=(0,P.wP)(k.db);try{let e={[s]:i},a=P.Dc.now(),t={by:d.displayName,at:a},h={aforadorStatus:"aforadorStatusLastUpdate",revisorStatus:"revisorStatusLastUpdate",digitacionStatus:"digitacionStatusLastUpdate",preliquidationStatus:"preliquidationStatusLastUpdate",incidentStatus:"incidentStatusLastUpdate",revisorAsignado:"revisorAsignadoLastUpdate",digitadorAsignado:"digitadorAsignadoLastUpdate",aforador:"aforadorStatusLastUpdate"};h[s]&&(e[h[s]]=t),m.update(o,e);let x={updatedAt:a,updatedBy:d.displayName,field:s,oldValue:null!=n?n:null,newValue:i};m.set((0,P.H9)(u),x),await m.commit(),r||c({title:"Guardado Autom\xe1tico",description:"El campo se ha actualizado."}),l()}catch(e){console.error("Error updating case:",e),c({title:"Error",description:"No se pudo guardar el cambio.",variant:"destructive"})}finally{x(a=>({...a,[e]:!1}))}},[d,a,c,l]);(0,r.useEffect)(()=>{(async()=>{let e=new Map;try{let a=(0,P.P)((0,P.rJ)(k.db,"users"),(0,P._M)("role","in",["aforador","coordinadora","supervisor","digitador"]));(await (0,P.GG)(a)).forEach(a=>{let s={uid:a.id,...a.data()};!e.has(s.uid)&&s.displayName&&e.set(s.uid,s)}),m(Array.from(e.values()))}catch(e){console.error("Error fetching users for digitization table",e)}})()},[]);let B=(e,s)=>{if("Completar Tr\xe1mite"===s){let s=a.find(a=>a.id===e);s&&A(s)}else _(e,"digitacionStatus",s)},$=async(e,s)=>{if(!d||!d.displayName||0===E.length)return;setIsLoading(!0);let i=(0,P.wP)(k.db);E.forEach(r=>{let t=(0,P.H9)(k.db,"AforoCases",r),n=(0,P.rJ)(t,"actualizaciones"),l=a.find(e=>e.id===r);if(l){let a="digitador"===e?"digitadorAsignado":"digitacionStatus",r={[a]:s},o=P.Dc.now(),c={by:d.displayName,at:o};"digitadorAsignado"===a&&(r.digitadorAsignadoLastUpdate=c),"digitacionStatus"===a&&(r.digitacionStatusLastUpdate=c),i.update(t,r);let u={updatedAt:o,updatedBy:d.displayName,field:a,oldValue:l[a]||null,newValue:s,comment:"Acci\xf3n masiva: ".concat(a," actualizado a ").concat(s,".")};i.set((0,P.H9)(n),u)}});try{await i.commit(),c({title:"Acci\xf3n Masiva Exitosa",description:"".concat(E.length," casos han sido actualizados.")}),z([]),l()}catch(e){console.error("Error with bulk action:",e),c({title:"Error",description:"No se pudo completar la acci\xf3n masiva.",variant:"destructive"})}finally{setIsLoading(!1),M({isOpen:!1,case:null,type:"digitador"}),V({isOpen:!1})}},H=e=>j(e),G=e=>v(e);if(s)return(0,i.jsxs)("div",{className:"flex justify-center items-center py-10",children:[(0,i.jsx)(o.A,{className:"h-8 w-8 animate-spin text-primary"}),(0,i.jsx)("p",{className:"ml-3 text-muted-foreground",children:"Cargando registros para digitaci\xf3n..."})]});if(t)return(0,i.jsxs)("div",{className:"text-center py-10 px-6 bg-destructive/10 rounded-lg",children:[(0,i.jsx)(J.A,{className:"mx-auto h-12 w-12 text-destructive"}),(0,i.jsx)("h3",{className:"mt-4 text-lg font-medium text-destructive",children:"Error al Cargar los Datos"}),(0,i.jsx)("p",{className:"mt-1 text-sm text-destructive/80 whitespace-pre-wrap",children:t})]});if(0===a.length)return(0,i.jsxs)("div",{className:"text-center py-10 px-6 bg-secondary/30 rounded-lg",children:[(0,i.jsx)(T.A,{className:"mx-auto h-12 w-12 text-muted-foreground"}),(0,i.jsx)("h3",{className:"mt-4 text-lg font-medium text-foreground",children:"No hay casos pendientes"}),(0,i.jsx)("p",{className:"mt-1 text-muted-foreground",children:"No hay casos de aforo aprobados esperando digitaci\xf3n con los filtros actuales."})]});let F=(null==d?void 0:d.role)==="admin"||(null==d?void 0:d.role)==="coordinadora"||(null==d?void 0:d.role)==="supervisor",Z=(null==d?void 0:d.role)==="digitador";return L?(0,i.jsx)("div",{className:"space-y-4",children:a.map(e=>(0,i.jsx)(e_,{caseItem:e,canEdit:F,isDigitador:Z,savingState:h,handleStatusChange:B,handleAutoSave:_,openCommentModal:G,openHistoryModal:H,setSelectedCaseForAssignment:w},e.id))}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ec.Bc,{children:(0,i.jsxs)("div",{className:"overflow-x-auto table-container rounded-lg border",children:[(0,i.jsx)("div",{className:"flex items-center gap-2 p-2",children:F&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(f.$,{variant:"outline",size:"sm",onClick:()=>M({isOpen:!0,case:null,type:"bulk-digitador"}),disabled:0===E.length,children:["Asignar Digitador (",E.length,")"]}),(0,i.jsxs)(f.$,{variant:"outline",size:"sm",onClick:()=>V({isOpen:!0}),disabled:0===E.length,children:["Asignar Estatus (",E.length,")"]})]})}),(0,i.jsxs)(U.XI,{children:[(0,i.jsx)(U.A0,{children:(0,i.jsxs)(U.Hj,{children:[(0,i.jsx)(U.nd,{className:"w-12",children:(0,i.jsx)(eN.S,{checked:E.length>0&&E.length===a.length,onCheckedChange:()=>{E.length===a.length?z([]):z(a.map(e=>e.id))}})}),(0,i.jsx)(U.nd,{children:"Acciones"}),(0,i.jsx)(U.nd,{children:"Ejecutivo"}),(0,i.jsx)(U.nd,{children:"NE"}),(0,i.jsx)(U.nd,{children:"Consignatario"}),(0,i.jsx)(U.nd,{children:"Asignar Digitador"}),(0,i.jsx)(U.nd,{children:"Estado Digitaci\xf3n"}),(0,i.jsx)(U.nd,{children:"Declaraci\xf3n Aduanera"})]})}),(0,i.jsx)(U.BF,{children:a.map(e=>{var a;let s="Tr\xe1mite Completo"===e.digitacionStatus,r="Pendiente"===e.digitacionStatus?"Pendiente de Digitaci\xf3n":e.digitacionStatus;return(0,i.jsxs)(U.Hj,{className:h[e.id]?"bg-amber-100":"","data-state":E.includes(e.id)?"selected":void 0,children:[(0,i.jsx)(U.nA,{children:(0,i.jsx)(eN.S,{checked:E.includes(e.id),onCheckedChange:()=>{var a;return a=e.id,void z(e=>e.includes(a)?e.filter(e=>e!==a):[...e,a])}})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)(N.rI,{children:[(0,i.jsx)(N.ty,{asChild:!0,children:(0,i.jsxs)(f.$,{variant:"ghost",className:"h-8 w-8 p-0",children:[(0,i.jsx)("span",{className:"sr-only",children:"Abrir men\xfa"}),(0,i.jsx)(q.A,{className:"h-4 w-4"})]})}),(0,i.jsxs)(N.SQ,{align:"end",children:[(0,i.jsxs)(N._2,{onSelect:()=>G(e),children:[(0,i.jsx)(ee.A,{className:"mr-2 h-4 w-4"})," Ver/Editar Observaci\xf3n"]}),(0,i.jsxs)(N._2,{onSelect:()=>H(e),children:[(0,i.jsx)(W.A,{className:"mr-2 h-4 w-4"})," Ver Bit\xe1cora"]})]})]})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-1",children:[(0,i.jsx)("span",{children:e.executive}),(0,i.jsx)(eB,{lastUpdate:{by:e.executive,at:e.createdAt},caseCreation:e.createdAt})]})}),(0,i.jsx)(U.nA,{className:"font-medium",children:e.ne}),(0,i.jsx)(U.nA,{children:e.consignee}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{children:e.digitadorAsignado||"Sin asignar"}),F&&!s&&(0,i.jsx)(f.$,{variant:"outline",size:"sm",onClick:()=>w(e),children:e.digitadorAsignado?"Cambiar":"Asignar"}),(0,i.jsx)(eB,{lastUpdate:e.digitadorAsignadoLastUpdate,caseCreation:e.createdAt})]})}),(0,i.jsx)(U.nA,{children:(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)(f.$,{variant:"outline",className:"w-[180px] justify-start",onClick:()=>V({isOpen:!0,caseData:e}),disabled:!Z&&!F||s,children:(0,i.jsx)(et.E,{variant:(e=>{switch(e){case"Tr\xe1mite Completo":return"default";case"En Proceso":return"secondary";case"Almacenado":return"outline";default:return"destructive"}})(r),children:r||"N/A"})}),(0,i.jsx)(eB,{lastUpdate:e.digitacionStatusLastUpdate,caseCreation:e.createdAt})]})}),(0,i.jsx)(U.nA,{children:s?(0,i.jsx)(et.E,{variant:"default",children:e.declaracionAduanera}):(0,i.jsx)(S.p,{placeholder:"Ingrese No. Declaraci\xf3n",defaultValue:null!=(a=e.declaracionAduanera)?a:"",onBlur:a=>_(e.id,"declaracionAduanera",a.target.value),disabled:!Z&&!F})})]},e.id)})})]})]})}),p&&(0,i.jsx)(ed.p,{isOpen:!!p,onClose:()=>j(null),caseData:p}),g&&(0,i.jsx)(eV,{isOpen:!!g,onClose:()=>v(null),caseData:g}),b&&(0,i.jsx)(eM,{isOpen:!!b,onClose:()=>A(null),caseData:b}),y&&(0,i.jsx)(eu.a,{isOpen:!!y,onClose:()=>w(null),caseData:y,assignableUsers:u.filter(e=>"digitador"===e.role||"coordinadora"===e.role||"supervisor"===e.role||"aforador"===e.role),onAssign:(e,a)=>{_(e,"digitadorAsignado",a),_(e,"digitadorAsignadoAt",P.Dc.now())},title:"Asignar Digitador",description:"Seleccione un usuario para asignar al caso NE: ".concat(y.ne)}),R.isOpen&&(0,i.jsx)(eu.a,{isOpen:R.isOpen,onClose:()=>M({isOpen:!1,case:null,type:"digitador"}),caseData:R.case,assignableUsers:u.filter(e=>"digitador"===e.role||"coordinadora"===e.role||"supervisor"===e.role),onAssign:(e,a)=>$("digitador",a),title:"Asignar Digitador Masivo",description:"Seleccione un usuario para asignar a los ".concat(E.length," casos seleccionados.")}),(0,i.jsx)(C.lG,{open:I.isOpen,onOpenChange:()=>V({isOpen:!1,caseData:void 0}),children:(0,i.jsxs)(C.Cf,{children:[(0,i.jsxs)(C.c7,{children:[(0,i.jsx)(C.L3,{children:I.caseData?"Cambiar Estatus para NE: ".concat(I.caseData.ne):"Asignar Estatus Masivo"}),(0,i.jsx)(C.rr,{children:I.caseData?"Seleccione el nuevo estado para este caso.":"Seleccione el estatus a aplicar a los ".concat(E.length," casos seleccionados.")})]}),(0,i.jsxs)(O.l6,{onValueChange:e=>{I.caseData?(B(I.caseData.id,e),V({isOpen:!1})):$("digitacionStatus",e)},children:[(0,i.jsx)(O.bq,{children:(0,i.jsx)(O.yv,{placeholder:"Seleccionar estatus..."})}),(0,i.jsxs)(O.gC,{children:[(0,i.jsx)(O.eb,{value:"Pendiente de Digitaci\xf3n",children:"Pendiente de Digitaci\xf3n"}),(0,i.jsx)(O.eb,{value:"En Proceso",children:"En Proceso"}),(0,i.jsx)(O.eb,{value:"Almacenado",children:"Almacenado"}),(0,i.jsx)(O.eb,{value:"Completar Tr\xe1mite",children:"Completar Tr\xe1mite"})]})]})]})})]})}var eU=s(82206),eH=s(4246);let eJ=function(e){let a=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!e)return"N/A";let s=e.toDate?e.toDate():new Date(e);return s instanceof Date&&!isNaN(s.getTime())?(0,en.GP)(s,a?"dd/MM/yy HH:mm":"dd/MM/yy",{locale:eo.es}):"Fecha Inv\xe1lida"},eT=e=>e instanceof P.Dc?eJ(e):"boolean"==typeof e?e?"S\xed":"No":null==e||""===e?"vac\xedo":"object"==typeof e?JSON.stringify(e):String(e),eG=(e,a,s,i)=>{let r=[[s],[i],[],e,...a],t=eH.Wp.aoa_to_sheet(r),n=e.map((e,s)=>({wch:Math.max(e.length,...a.map(e=>String(e[s]||"").length))+2}));return t["!cols"]=n,t};async function eq(e,a){let s=new Date,i=(0,en.GP)(s,"dd/MM/yy HH:mm",{locale:eo.es}),r=eG(["NE","Consignatario","Mercanc\xeda","Modelo (Patr\xf3n)","Aforador","Fecha Asignaci\xf3n","Total Posiciones","Entregado a Aforo","Revisor Asignado","Estado Revisor","Observaci\xf3n Revisor","Estado Aforador","Estado Digitaci\xf3n","Digitador Asignado","Fecha Asign. Digitador","Declaraci\xf3n Aduanera","Incidencia Reportada","Motivo Incidencia","Estado Incidencia"],e.map(e=>[e.ne,e.consignee,e.merchandise,e.declarationPattern,e.aforador,eJ(e.assignmentDate),e.totalPosiciones||"N/A",eJ(e.entregadoAforoAt),e.revisorAsignado||"N/A",e.revisorStatus||"N/A",e.observacionRevisor||"",e.aforadorStatus||"N/A",e.digitacionStatus||"N/A",e.digitadorAsignado||"N/A",eJ(e.digitadorAsignadoAt),e.declaracionAduanera||"N/A",e.incidentReported?"S\xed":"No",e.incidentReason||"N/A",e.incidentStatus||"N/A"]),"Reporte Aforo Casos - Customs Reports","Generado el: ".concat(i));a.sort((e,a)=>e.caseNe<a.caseNe?-1:e.caseNe>a.caseNe?1:(e.updatedAt instanceof Date?e.updatedAt.getTime():e.updatedAt.toMillis())-(a.updatedAt instanceof Date?a.updatedAt.getTime():a.updatedAt.toMillis()));let t=eG(["NE del Caso","Fecha de Actualizaci\xf3n","Actualizado Por","Campo Modificado","Valor Anterior","Valor Nuevo","Comentario"],a.map(e=>[e.caseNe,eJ(e.updatedAt),e.updatedBy,e.field,eT(e.oldValue),eT(e.newValue),e.comment||""]),"Bit\xe1cora de Cambios - Customs Reports","Generado el: ".concat(i)),n=eH.Wp.book_new();eH.Wp.book_append_sheet(n,r,"Reporte Aforo Casos"),eH.Wp.book_append_sheet(n,t,"Bit\xe1cora de Cambios"),eH._h(n,"Reporte_Aforo_".concat(s.toISOString().split("T")[0],".xlsx"))}let eF=[{value:0,label:"Enero"},{value:1,label:"Febrero"},{value:2,label:"Marzo"},{value:3,label:"Abril"},{value:4,label:"Mayo"},{value:5,label:"Junio"},{value:6,label:"Julio"},{value:7,label:"Agosto"},{value:8,label:"Septiembre"},{value:9,label:"Octubre"},{value:10,label:"Noviembre"},{value:11,label:"Diciembre"}],eZ=new Date().getFullYear(),eW=Array.from({length:5},(e,a)=>eZ-a);function eQ(){let{user:e,loading:a}=(0,n.A)(),s=(0,t.useRouter)(),{toast:A}=(0,D.dj)(),[y,w]=(0,r.useState)(!1),[C,E]=(0,r.useState)(!1),[z,I]=(0,r.useState)([]),[V,R]=(0,r.useState)(!0),[M,L]=(0,r.useState)(null),[_,B]=(0,r.useState)(""),[U,H]=(0,r.useState)(""),[J,T]=(0,r.useState)("range"),[G,q]=(0,r.useState)(),[F,Z]=(0,r.useState)(new Date().getMonth()),[W,Q]=(0,r.useState)(eZ),[X,Y]=(0,r.useState)(!1),[K,ee]=(0,r.useState)({dateFilterType:"range"}),[ea,es]=(0,r.useState)(!1),ei=(null==e?void 0:e.role)==="aforador"||(null==e?void 0:e.role)==="admin",er=(null==e?void 0:e.role)==="admin"||(null==e?void 0:e.role)==="supervisor"&&(null==e?void 0:e.roleTitle)==="PSMT",et=(0,r.useCallback)(()=>{if(!e)return;R(!0);let a=(0,P.P)((0,P.rJ)(k.db,"AforoCases"),(0,P.My)("createdAt","desc"));return(0,P.aQ)(a,async e=>{let a=e.docs.map(e=>({id:e.id,...e.data()})),s=a.map(e=>e.worksheetId).filter(Boolean);if(0===s.length){I(a.map(e=>({...e,worksheet:null}))),R(!1);return}let i=[];for(let e=0;e<s.length;e+=30){let a=s.slice(e,e+30);a.length>0&&i.push((0,P.GG)((0,P.P)((0,P.rJ)(k.db,"worksheets"),(0,P._M)((0,P.Fs)(),"in",a))))}try{let e=await Promise.all(i),s=new Map;e.forEach(e=>e.forEach(e=>s.set(e.id,{id:e.id,...e.data()})));let r=a.map(e=>({...e,worksheet:s.get(e.worksheetId||"")||null}));I(r)}catch(e){console.error("Error fetching worksheets for cases:",e),L("No se pudieron cargar los detalles de las hojas de trabajo.")}finally{R(!1)}},e=>{console.error("Error fetching main aforo cases:",e),L("Error al cargar los casos de aforo."),R(!1)})},[e]);(0,r.useEffect)(()=>{let e=et();return()=>{e&&e()}},[et]),(0,r.useEffect)(()=>{!a&&(e?e.hasReportsAccess||s.push("/thereporter/pending"):s.push("/"))},[e,a,s]);let en=async()=>{if(0===z.length)return void A({title:"No hay datos",description:"No hay casos en la tabla para exportar.",variant:"secondary"});es(!0);try{let e=[];for(let a of z){let s=(0,P.P)((0,P.rJ)(k.db,"AforoCases",a.id,"actualizaciones"),(0,P.My)("updatedAt","asc"));(await (0,P.GG)(s)).forEach(s=>{e.push({...s.data(),caseNe:a.ne})})}await eq(z,e)}catch(e){console.error("Error exporting data with audit logs: ",e),A({title:"Error de Exportaci\xf3n",description:"No se pudieron obtener todos los detalles para el reporte.",variant:"destructive"})}finally{es(!1)}},el=async()=>{if(!(null==e?void 0:e.displayName))return void A({title:"Error",description:"Debe estar autenticado.",variant:"destructive"});E(!0);try{let a=(0,P.P)((0,P.rJ)(k.db,"AforoCases"),(0,P._M)("revisorStatus","==","Aprobado"),(0,P._M)("preliquidationStatus","==","Aprobada")),s=(await (0,P.GG)(a)).docs.map(e=>({id:e.id,...e.data()})).filter(e=>!e.digitacionStatus||"N/A"===e.digitacionStatus||"Pendiente"===e.digitacionStatus);if(0===s.length){A({title:"Todo al d\xeda",description:"No hay nuevos casos aprobados para enviar a digitaci\xf3n."}),E(!1);return}let i=(0,P.wP)(k.db),r="Pendiente de Digitaci\xf3n";s.forEach(a=>{let s=(0,P.H9)(k.db,"AforoCases",a.id);i.update(s,{digitacionStatus:r});let t=(0,P.H9)((0,P.rJ)(s,"actualizaciones")),n={updatedAt:new Date,updatedBy:e.displayName,field:"digitacionStatus",oldValue:a.digitacionStatus||"N/A",newValue:r,comment:"Env\xedo masivo a digitaci\xf3n."};i.set(t,n)}),await i.commit(),A({title:"Env\xedo Exitoso",description:"".concat(s.length," caso(s) han sido enviados a digitaci\xf3n.")}),et()}catch(e){console.error("Error sending cases to digitization:",e),A({title:"Error en env\xedo masivo",description:"No se pudieron enviar los casos a digitaci\xf3n.",variant:"destructive"})}finally{E(!1)}};return!a&&e&&e.hasReportsAccess?(0,i.jsxs)(l.G,{children:[(0,i.jsx)("div",{className:"space-y-6",children:(0,i.jsx)(b.tU,{defaultValue:"aforo",className:"w-full",children:(0,i.jsxs)(v.Zp,{children:[(0,i.jsx)(v.aR,{children:(0,i.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,i.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between sm:items-center gap-4",children:[(0,i.jsxs)(b.j7,{children:[(0,i.jsx)(b.Xi,{value:"aforo",children:"Aforo"}),(0,i.jsx)(b.Xi,{value:"digitacion",children:"Digitaci\xf3n"})]}),ei&&(0,i.jsxs)(N.rI,{children:[(0,i.jsx)(N.ty,{asChild:!0,children:(0,i.jsxs)(f.$,{children:[(0,i.jsx)(d.A,{className:"mr-2 h-4 w-4"}),"Crear Registro",(0,i.jsx)(c.A,{className:"ml-2 h-4 w-4"})]})}),(0,i.jsxs)(N.SQ,{children:[(0,i.jsx)(N.lp,{children:"Tipo de Registro"}),(0,i.jsx)(N.mB,{}),(0,i.jsx)(N._2,{onSelect:()=>w(!0),children:"Registro de Aforo"}),(0,i.jsx)(N._2,{disabled:!0,children:"Registro de Incidencia (pr\xf3ximamente)"})]})]})]}),(0,i.jsxs)("div",{className:"border-t pt-4 space-y-4",children:[(0,i.jsx)("p",{className:"text-sm font-medium text-muted-foreground",children:"Filtros de B\xfasqueda"}),(0,i.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,i.jsx)(S.p,{placeholder:"Buscar por NE...",value:_,onChange:e=>B(e.target.value),className:"w-full sm:w-auto flex-grow"}),(0,i.jsx)(S.p,{placeholder:"Buscar por Consignatario...",value:U,onChange:e=>H(e.target.value),className:"w-full sm:w-auto flex-grow"})]}),(0,i.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,i.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,i.jsxs)(f.$,{variant:"range"===J?"default":"ghost",size:"sm",onClick:()=>T("range"),children:[(0,i.jsx)(u.A,{className:"mr-2 h-4 w-4"})," Rango"]}),(0,i.jsxs)(f.$,{variant:"month"===J?"default":"ghost",size:"sm",onClick:()=>T("month"),children:[(0,i.jsx)(m.A,{className:"mr-2 h-4 w-4"})," Mes"]}),(0,i.jsxs)(f.$,{variant:"today"===J?"default":"ghost",size:"sm",onClick:()=>T("today"),children:[(0,i.jsx)(h.A,{className:"mr-2 h-4 w-4"})," Hoy"]})]}),"range"===J&&(0,i.jsx)(eU.S,{date:G,onDateChange:q}),"month"===J&&(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)(O.l6,{value:String(F),onValueChange:e=>Z(Number(e)),children:[(0,i.jsx)(O.bq,{className:"w-[180px]",children:(0,i.jsx)(O.yv,{})}),(0,i.jsx)(O.gC,{children:eF.map(e=>(0,i.jsx)(O.eb,{value:String(e.value),children:e.label},e.value))})]}),(0,i.jsxs)(O.l6,{value:String(W),onValueChange:e=>Q(Number(e)),children:[(0,i.jsx)(O.bq,{className:"w-[120px]",children:(0,i.jsx)(O.yv,{})}),(0,i.jsx)(O.gC,{children:eW.map(e=>(0,i.jsx)(O.eb,{value:String(e),children:e},e))})]})]})]}),(0,i.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-2",children:[(0,i.jsxs)(f.$,{onClick:()=>{let e;if("range"===J)e=G;else if("month"===J)e={from:new Date(W,F,1),to:new Date(W,F+1,0)};else if("today"===J){let a=new Date;e={from:a,to:a}}let a={dateFilterType:J,dateRange:e};_.trim()&&(a.ne=_.trim()),U.trim()&&(a.consignee=U.trim()),ee(a)},className:"w-full sm:w-auto",children:[(0,i.jsx)(x.A,{className:"mr-2 h-4 w-4"})," Buscar"]}),(0,i.jsxs)("div",{className:"flex justify-end gap-2 w-full sm:w-auto",children:[er&&(0,i.jsxs)(f.$,{onClick:el,variant:"outline",disabled:C,children:[C?(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}):(0,i.jsx)(p.A,{className:"mr-2 h-4 w-4"}),C?"Enviando...":"Enviar a Digitaci\xf3n"]}),(0,i.jsxs)(f.$,{variant:X?"secondary":"outline",onClick:()=>Y(!X),children:[(0,i.jsx)(j.A,{className:"mr-2 h-4 w-4"})," Pendientes"]}),(0,i.jsx)(f.$,{variant:"outline",onClick:()=>{B(""),H(""),q(void 0),Y(!1),ee({dateFilterType:"range"})},children:"Limpiar Filtros"}),(0,i.jsxs)(f.$,{onClick:en,disabled:0===z.length||ea,children:[ea?(0,i.jsx)(o.A,{className:"mr-2 h-4 w-4 animate-spin"}):(0,i.jsx)(g.A,{className:"mr-2 h-4 w-4"}),ea?"Exportando...":"Exportar"]})]})]})]})]})}),(0,i.jsxs)(v.Wu,{children:[(0,i.jsx)(b.av,{value:"aforo",children:(0,i.jsx)(ez,{cases:z,isLoading:V,error:M,onRefresh:et})}),(0,i.jsx)(b.av,{value:"digitacion",children:(0,i.jsx)(e$,{cases:z,isLoading:V,error:M,onRefresh:et})})]})]})})}),y&&(0,i.jsx)($,{isOpen:y,onClose:()=>w(!1)})]}):(0,i.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-background",children:(0,i.jsx)(o.A,{className:"h-12 w-12 animate-spin text-primary"})})}},9691:(e,a,s)=>{"use strict";s.d(a,{j:()=>l});var i=s(95155),r=s(51834),t=s(17037),n=s(59321);function l(e){let{isOpen:a,onClose:s,worksheet:l}=e;return a&&l?(0,i.jsx)(r.lG,{open:a,onOpenChange:s,children:(0,i.jsx)(r.Cf,{className:"max-w-4xl p-0 h-[90vh] flex flex-col",children:(0,i.jsx)(t.F,{className:"flex-grow",children:(0,i.jsx)("div",{className:"p-6",children:(0,i.jsx)(n.v,{worksheet:l,onClose:s})})})})}):null}},43222:(e,a,s)=>{Promise.resolve().then(s.bind(s,3145))}},e=>{e.O(0,[2992,7138,3524,4865,9255,3744,5282,9351,3504,6505,4221,5330,7374,5479,5171,2228,7913,6190,3152,8441,1255,7358],()=>e(e.s=43222)),_N_E=e.O()}]);