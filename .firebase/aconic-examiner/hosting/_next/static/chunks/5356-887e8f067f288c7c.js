(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5356],{15457:(e,a,t)=>{"use strict";t.d(a,{j:()=>M});var s=t(95155),n=t(12115),o=t(15239),i=t(3998),r=t(86948),l=t(26615),c=t(44381),d=t(92129),u=t(21255),m=t(27237),p=t(86067),x=t(39075),h=t(55666),N=t(22823),g=t(91719),A=t(12158),f=t(19201),b=t(5225),v=t(27500),E=t(75004),j=t(53489),y=t(21992),C=t(76251),D=t(19708),I=t(77059),S=t(93129),w=t(5282),R=t(80160);let O=e=>{let a,{label:t,value:n,icon:o}=e;return a="boolean"==typeof n?n?"S\xed":"No":n instanceof D.Dc?(e=>{if(!e)return"N/A";let a=e.toDate();return(0,w.GP)(a,"dd/MM/yy HH:mm",{locale:R.es})})(n):String(null!=n?n:"N/A"),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center",children:[o&&(0,s.jsx)("span",{className:"mr-2 text-primary",children:o}),(0,s.jsx)("p",{className:"text-xs font-medium text-muted-foreground",children:t})]}),(0,s.jsx)("p",{className:"text-sm text-foreground ml-6",children:a})]})},M=e=>{var a;let{exam:t,onClose:D}=e,[w,R]=(0,n.useState)(!1);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(r.Zp,{className:"mt-6 w-full max-w-5xl mx-auto custom-shadow",id:"printable-area",children:[(0,s.jsxs)(r.aR,{children:[(0,s.jsx)(o.default,{src:"/imagenes/HEADERSEXA.svg",alt:"Examen Header",width:800,height:100,className:"w-full h-auto mb-4",priority:!0}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(r.ZB,{className:"text-xl md:text-2xl font-semibold text-foreground",children:["Detalles del Examen: ",t.ne]}),(0,s.jsx)("button",{onClick:D,className:"absolute -top-2 -right-2 p-1 text-destructive hover:text-destructive/80 no-print",children:(0,s.jsx)(l.A,{className:"h-6 w-6"})})]}),(0,s.jsx)(r.BT,{className:"text-muted-foreground",children:"Informaci\xf3n del examen recuperada de la base de datos."})]}),(0,s.jsxs)(r.Wu,{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 bg-secondary/30 p-4 rounded-md shadow-sm text-sm print:grid-cols-2 print:gap-x-8 print:gap-y-3",children:[(0,s.jsx)(O,{label:"NE (Tracking NX1)",value:t.ne}),(0,s.jsx)(O,{label:"Referencia",value:t.reference}),(0,s.jsx)(O,{label:"Consignatario",value:t.consignee}),(0,s.jsx)(O,{label:"Gestor del Examen",value:t.manager}),(0,s.jsx)(O,{label:"Ubicaci\xf3n Mercanc\xeda",value:t.location}),(0,s.jsx)(O,{label:"Guardado por (correo)",value:t.savedBy}),(0,s.jsx)(O,{label:"Fecha y Hora de Guardado",value:t.savedAt})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"text-lg font-medium mb-3 text-foreground",children:["Productos (",(null==(a=t.products)?void 0:a.length)||0,")"]}),t.products&&t.products.length>0?(0,s.jsx)("div",{className:"space-y-6 print:space-y-4",children:t.products.map((e,a)=>(0,s.jsxs)("div",{className:"p-4 border border-border bg-card rounded-lg shadow print-product-container print:border print:border-gray-200 print:shadow-none print:bg-white",children:[(0,s.jsxs)("h5",{className:"text-md font-semibold mb-3 text-primary print:border-b print:pb-2 print:mb-4",children:["Producto ",a+1,e.itemNumber&&(0,s.jsxs)("span",{className:"text-sm font-normal text-muted-foreground",children:[" (Item: ",e.itemNumber,")"]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 print:grid-cols-2 gap-x-6 gap-y-4",children:[(0,s.jsx)(O,{label:"N\xfamero de Item",value:e.itemNumber,icon:(0,s.jsx)(c.A,{size:16})}),(0,s.jsx)(O,{label:"Peso",value:e.weight,icon:(0,s.jsx)(d.A,{size:16})}),(0,s.jsx)(O,{label:"Marca",value:e.brand,icon:(0,s.jsx)(u.A,{size:16})}),(0,s.jsx)(O,{label:"Modelo",value:e.model,icon:(0,s.jsx)(m.A,{size:16})}),(0,s.jsx)(O,{label:"Unidad de Medida",value:e.unitMeasure,icon:(0,s.jsx)(p.A,{size:16})}),(0,s.jsx)(O,{label:"Serie",value:e.serial,icon:(0,s.jsx)(x.A,{size:16})}),(0,s.jsx)(O,{label:"Origen",value:e.origin,icon:(0,s.jsx)(h.A,{size:16})}),(0,s.jsx)(O,{label:"Numeraci\xf3n de Bultos",value:e.numberPackages,icon:(0,s.jsx)(N.A,{size:16})}),(0,s.jsx)(O,{label:"Cantidad de Bultos",value:e.quantityPackages,icon:(0,s.jsx)(g.A,{size:16})}),(0,s.jsx)(O,{label:"Cantidad de Unidades",value:e.quantityUnits,icon:(0,s.jsx)(A.A,{size:16})}),(0,s.jsx)(O,{label:"Estado de Mercanc\xeda (Condici\xf3n)",value:e.packagingCondition,icon:(0,s.jsx)(f.A,{size:16})}),(0,s.jsx)("div",{className:"md:col-span-2 lg:col-span-3 print:col-span-2",children:(0,s.jsx)(O,{label:"Descripci\xf3n",value:e.description,icon:(0,s.jsx)(b.A,{size:16})})}),(0,s.jsx)("div",{className:"md:col-span-2 lg:col-span-3 print:col-span-2",children:(0,s.jsx)(O,{label:"Observaci\xf3n",value:e.observation,icon:(0,s.jsx)(v.A,{size:16})})}),(0,s.jsx)("div",{className:"md:col-span-full pt-2 mt-2 border-t border-border print:col-span-2",children:(0,s.jsx)(O,{label:"Estado General del Producto",value:(e=>{let a=[];return(e.isConform&&a.push("Conforme a factura"),e.isExcess&&a.push("Excedente"),e.isMissing&&a.push("Faltante"),e.isFault&&a.push("Aver\xeda"),0===a.length)?"Sin estado espec\xedfico":a.join(", ")})(e),icon:(0,s.jsx)(E.A,{size:16})})})]})]},e.id||a))}):(0,s.jsx)("p",{className:"text-muted-foreground",children:"No hay productos registrados en este examen."})]}),(0,s.jsx)(o.default,{src:"/imagenes/FOOTEREXA.svg",alt:"Examen Footer",width:800,height:50,className:"w-full h-auto mt-6"})]}),(0,s.jsxs)(r.wL,{className:"justify-end gap-2 no-print border-t pt-4",children:[(0,s.jsxs)(i.$,{type:"button",onClick:()=>{(0,I.qb)(t)},variant:"outline",children:[(0,s.jsx)(j.A,{className:"mr-2 h-4 w-4"})," Exportar"]}),(0,s.jsxs)(i.$,{type:"button",onClick:()=>R(!0),variant:"outline",children:[(0,s.jsx)(y.A,{className:"mr-2 h-4 w-4"})," Bit\xe1cora"]}),(0,s.jsxs)(i.$,{type:"button",onClick:()=>{window.print()},variant:"outline",children:[(0,s.jsx)(C.A,{className:"mr-2 h-4 w-4"})," Imprimir"]})]})]}),t.id&&(0,s.jsx)(S.X,{isOpen:w,onClose:()=>R(!1),examId:t.id})]})}},31120:(e,a,t)=>{"use strict";t.d(a,{T:()=>i});var s=t(95155),n=t(12115),o=t(64269);let i=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)("textarea",{className:(0,o.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...n})});i.displayName="Textarea"},32383:()=>{},51834:(e,a,t)=>{"use strict";t.d(a,{Cf:()=>u,Es:()=>p,HM:()=>c,L3:()=>x,c7:()=>m,lG:()=>r,rr:()=>h});var s=t(95155),n=t(12115),o=t(89511),i=t(64269);let r=o.bL;o.l9;let l=o.ZL,c=o.bm,d=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(o.hJ,{ref:a,className:(0,i.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...n})});d.displayName=o.hJ.displayName;let u=n.forwardRef((e,a)=>{let{className:t,children:n,...r}=e;return(0,s.jsxs)(l,{children:[(0,s.jsx)(d,{}),(0,s.jsxs)(o.UC,{ref:a,className:(0,i.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...r,children:[n,(0,s.jsx)(o.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:(0,s.jsx)("span",{className:"sr-only",children:"Close"})})]})]})});u.displayName=o.UC.displayName;let m=e=>{let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,i.cn)("flex flex-col space-y-1.5 text-center sm:text-left",a),...t})};m.displayName="DialogHeader";let p=e=>{let{className:a,...t}=e;return(0,s.jsx)("div",{className:(0,i.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...t})};p.displayName="DialogFooter";let x=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(o.hE,{ref:a,className:(0,i.cn)("text-lg font-semibold leading-none tracking-tight",t),...n})});x.displayName=o.hE.displayName;let h=n.forwardRef((e,a)=>{let{className:t,...n}=e;return(0,s.jsx)(o.VY,{ref:a,className:(0,i.cn)("text-sm text-muted-foreground",t),...n})});h.displayName=o.VY.displayName},77059:(e,a,t)=>{"use strict";t.d(a,{j5:()=>r,qb:()=>l,qf:()=>m});var s=t(19708),n=t(4246),o=t(5282),i=t(80160);function r(e,a){let t="EXAMEN PREVIO AGENCIA ACONIC - CustomsEX-p\n";t+="===========================================\n\n",t+="INFORMACI\xd3N GENERAL DEL EXAMEN:\n",t+="NE: ".concat(e.ne,"\n"),t+="Referencia: ".concat(e.reference||"N/A","\n"),t+="Consignatario: ".concat(e.consignee,"\n"),t+="Gestor: ".concat(e.manager,"\n"),t+="Ubicaci\xf3n: ".concat(e.location,"\n\n"),t+="PRODUCTOS:\n",(Array.isArray(a)?a:[]).forEach((e,a)=>{t+="\n--- Producto ".concat(a+1," ---\n"),t+="N\xfamero de Item: ".concat(e.itemNumber||"N/A","\n"),t+="Numeraci\xf3n de Bultos: ".concat(e.numberPackages||"N/A","\n"),t+="Cantidad de Bultos: ".concat(e.quantityPackages||0,"\n"),t+="Cantidad de Unidades: ".concat(e.quantityUnits||0,"\n"),t+="Descripci\xf3n: ".concat(e.description||"N/A","\n"),t+="Marca: ".concat(e.brand||"N/A","\n"),t+="Modelo: ".concat(e.model||"N/A","\n"),t+="Serie: ".concat(e.serial||"N/A","\n"),t+="Origen: ".concat(e.origin||"N/A","\n"),t+="Estado de Mercanc\xeda: ".concat(e.packagingCondition||"N/A","\n"),t+="Unidad de Medida: ".concat(e.unitMeasure||"N/A","\n"),t+="Peso: ".concat(e.weight||"N/A","\n"),t+="Observaci\xf3n: ".concat(e.observation||"N/A","\n");let s=[];e.isConform&&s.push("Conforme a factura"),e.isExcess&&s.push("Excedente"),e.isMissing&&s.push("Faltante"),e.isFault&&s.push("Aver\xeda"),t+="Estado: ".concat(s.length>0?s.join(", "):"Sin estado espec\xedfico","\n")});let s=new Blob([t],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download="CustomsEX-p_".concat(e.ne,"_").concat(new Date().toISOString().split("T")[0],".txt"),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}function l(e){var a,t;let s=new Date,r=(0,o.GP)(s,"dd/MM/yy HH:mm",{locale:i.es}),l=[["EXAMEN PREVIO AGENCIA ACONIC - CustomsEX-p"],[],["INFORMACI\xd3N GENERAL DEL EXAMEN:"],["NE:",e.ne],["Referencia:",e.reference||"N/A"],["Consignatario:",e.consignee],["Gestor del Examen:",e.manager],["Ubicaci\xf3n Mercanc\xeda:",e.location],["Fotos:",{v:"Abrir Carpeta de Fotos",t:"s",l:{Target:"https://aconisani-my.sharepoint.com/:f:/g/personal/asuntos_juridicos_aconic_com_ni/Emrpj4Ss8bhDifpuYc8U_bwBj9r29FGcXxzfxu4PSh2tEQ?e=FhIPTt",Tooltip:"Ir a la carpeta de fotos en SharePoint"}}],[],["PRODUCTOS:"]],c=["N\xfamero de Item","Numeraci\xf3n de Bultos","Cantidad de Bultos","Cantidad de Unidades","Descripci\xf3n","Marca","Modelo","Origen","Estado de Mercanc\xeda","Peso","Unidad de Medida","Serie","Observaci\xf3n","Estado"],d=[...l,c,...(Array.isArray(e.products)?e.products:[]).map(e=>{let a="",t=[];return e.isConform&&t.push("Conforme"),e.isExcess&&t.push("Excedente"),e.isMissing&&t.push("Faltante"),e.isFault&&t.push("Aver\xeda"),a=t.length>0?t.join("/"):"S/E",[e.itemNumber||"N/A",e.numberPackages||"N/A",e.quantityPackages||0,e.quantityUnits||0,e.description||"N/A",e.brand||"N/A",e.model||"N/A",e.origin||"N/A",e.packagingCondition||"N/A",e.weight||"N/A",e.unitMeasure||"N/A",e.serial||"N/A",e.observation||"N/A",a]})],u=n.Wp.aoa_to_sheet(d),m=c.map((e,a)=>({wch:Math.max(e.length,...d.slice(l.length).map(e=>e[a]?String(e[a]).length:0))+2})),p=l.slice(0,l.length-2).map(e=>String(e[0]||"")),x=l.slice(0,l.length-2).map(e=>{let a=e[1];return"object"==typeof a&&null!==a&&"v"in a?String(a.v||""):String(a||"")});m.length>0&&(m[0].wch=Math.max((null==(a=m[0])?void 0:a.wch)||0,...p.map(e=>e.length+2))),m.length>1&&(m[1].wch=Math.max((null==(t=m[1])?void 0:t.wch)||0,...x.map(e=>e.length+5))),u["!cols"]=m;let h=[["DETALLES DE SISTEMA DEL EXAMEN:"]];e.savedBy?h.push(["Guardado por (correo):",e.savedBy]):h.push(["Guardado por (correo):","N/A (No guardado en BD a\xfan o dato no disponible)"]);let N=e=>{if(!e)return"N/A";let a=(null==e?void 0:e.toDate)?e.toDate():e;return a instanceof Date&&!isNaN(a.getTime())?(0,o.GP)(a,"dd/MM/yy HH:mm",{locale:i.es}):"Fecha inv\xe1lida"};h.push(["Fecha y Hora de Inicio:",N(e.createdAt)]),h.push(["Fecha y Hora de \xdaltimo Guardado:",N(e.savedAt)]),h.push(["Fecha y Hora de Finalizaci\xf3n:",e.completedAt?N(e.completedAt):"Examen no finalizado"]),h.push(["Fecha y Hora de Exportaci\xf3n:",r]);let g=n.Wp.aoa_to_sheet(h),A=[{wch:Math.max(...h.map(e=>String(e[0]).length))+2},{wch:Math.max(...h.map(e=>String(e[1]).length))+5}];g["!cols"]=A;let f=n.Wp.book_new();n.Wp.book_append_sheet(f,u,"Examen ".concat(e.ne)),n.Wp.book_append_sheet(f,g,"Detalle de Sistema"),n._h(f,"CustomsEX-p_".concat(e.ne,"_").concat(new Date().toISOString().split("T")[0],".xlsx"))}let c=function(e){let a=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!e)return"N/A";let t=e.toDate?e.toDate():new Date(e);return t instanceof Date&&!isNaN(t.getTime())?(0,o.GP)(t,a?"dd/MM/yy HH:mm":"dd/MM/yy",{locale:i.es}):"Fecha Inv\xe1lida"},d=e=>e instanceof s.Dc?c(e):"boolean"==typeof e?e?"S\xed":"No":null==e||""===e?"vac\xedo":"object"==typeof e?JSON.stringify(e):String(e),u=(e,a,t,s)=>{let o=[[t],[s],[],e,...a],i=n.Wp.aoa_to_sheet(o),r=e.map((e,t)=>({wch:Math.max(e.length,...a.map(e=>String(e[t]||"").length))+2}));return i["!cols"]=r,i};async function m(e,a){let t=new Date,s=(0,o.GP)(t,"dd/MM/yy HH:mm",{locale:i.es}),r=u(["NE","INICIO DE OPERACION","RESA","VENCIMIENTO DE RESA","CONSIGNATARIO","FACTURA","ASIGNACION DE AFORO","ESTATUS DE REVISOR","ESTATUS DIGITACION","SELECTIVO","FECHA DE DESPACHO","TIPO INCIDENCIA","FACTURADO","FECHA DE FACTURACION","CUENTA DE REGISTRO","ESTATUS EJECUTIVO (AMPLIADO)"],e.map(e=>{var a;let t=["Aforador: ".concat(e.aforadorStatus||"N/A"),"Revisor: ".concat(e.revisorStatus||"N/A"),"Preliquidaci\xf3n: ".concat(e.preliquidationStatus||"N/A"),"Digitaci\xf3n: ".concat(e.digitacionStatus||"N/A")].join(" | ");return[e.ne,c(e.createdAt),(null==(a=e.worksheet)?void 0:a.resa)||"N/A",c(e.resaDueDate,!1),e.consignee,e.facturaNumber||"N/A",c(e.assignmentDate),e.revisorStatus||"N/A",e.digitacionStatus||"N/A",e.selectividad||"N/A",c(e.fechaDespacho,!1),e.incidentType||"N/A",e.facturado?"S\xed":"No",c(e.facturadoAt),e.cuentaDeRegistro||"N/A",t]}),"Reporte Ejecutivo - Customs Reports","Generado el: ".concat(s)),l=u(["NE","Consignatario","Declaraci\xf3n","Aduana Despacho","Monto de Preliquidaci\xf3n (USD)","Proceso","Levante Solicitado","Ampliaci\xf3n de Plazo","Vencimiento de Caso","Asignado a Legal"],e.filter(e=>e.hasValueDoubt).map(e=>{var a,t;return[e.ne,e.consignee,e.declaracionAduanera||"N/A",(null==(a=e.worksheet)?void 0:a.dispatchCustoms)||"N/A",null!=(t=e.valueDoubtAmount)?t:"N/A",e.valueDoubtStatus||"N/A",e.valueDoubtLevanteRequested?"S\xed":"No",e.valueDoubtExtensionRequested?"S\xed":"No",c(e.valueDoubtDueDate,!1),e.valueDoubtAssignedToLegal?"S\xed":"No"]}),"Casos con Duda de Valor","Generado el: ".concat(s)),m=u(["NE","CONSIGNATARIO","DECLARACION ADUANERA","PAGO INICIAL (SI/NO)","RECIBO DE CAJA PAGO INICIAL","MONTO DE DECLARACION INICIAL","ADUANA DE DESPACHO","MOTIVO DE LA RECTIFICACION","OBSERVACIONES","ESTADO INCIDENCIA","REVISADO POR","FECHA REVISI\xd3N"],e.filter(e=>"Rectificacion"===e.incidentType).map(e=>{var a,t;return[e.ne,e.consignee,e.declaracionAduanera||"N/A",e.pagoInicialRealizado?"S\xed":"No",e.reciboDeCajaPagoInicial||"N/A",null!=(t=e.montoPagoInicial)?t:"N/A",(null==(a=e.worksheet)?void 0:a.dispatchCustoms)||"N/A",e.motivoRectificacion||"",e.observaciones||"",e.incidentStatus||"N/A",e.incidentReviewedBy||"N/A",c(e.incidentReviewedAt,!1)]}),"Casos con Complementaria (Rectificaci\xf3n)","Generado el: ".concat(s));a.sort((e,a)=>e.caseNe<a.caseNe?-1:e.caseNe>a.caseNe?1:(e.updatedAt instanceof Date?e.updatedAt.getTime():e.updatedAt.toMillis())-(a.updatedAt instanceof Date?a.updatedAt.getTime():a.updatedAt.toMillis()));let p=u(["NE del Caso","Fecha de Actualizaci\xf3n","Actualizado Por","Campo Modificado","Valor Anterior","Valor Nuevo","Comentario"],a.map(e=>[e.caseNe,c(e.updatedAt),e.updatedBy,e.field,d(e.oldValue),d(e.newValue),e.comment||""]),"Bit\xe1cora de Cambios - Customs Reports","Generado el: ".concat(s)),x=n.Wp.book_new();n.Wp.book_append_sheet(x,r,"Reporte Ejecutivo"),n.Wp.book_append_sheet(x,l,"Duda de Valor"),n.Wp.book_append_sheet(x,m,"Rectificaciones"),n.Wp.book_append_sheet(x,p,"Bit\xe1cora de Cambios"),n._h(x,"Reporte_Ejecutivo_".concat(t.toISOString().split("T")[0],".xlsx"))}},83686:()=>{},93129:(e,a,t)=>{"use strict";t.d(a,{X:()=>f});var s=t(95155),n=t(12115),o=t(14585),i=t(19708),r=t(54901),l=t(3998),c=t(31120),d=t(51834),u=t(17037),m=t(26615),p=t(92033),x=t(94979),h=t(15894),N=t(64269),g=t(84824),A=t(80160);function f(e){let{isOpen:a,onClose:t,examId:f}=e,{user:b}=(0,r.A)(),{toast:v}=(0,h.dj)(),[E,j]=(0,n.useState)([]),[y,C]=(0,n.useState)(""),[D,I]=(0,n.useState)(!1),[S,w]=(0,n.useState)(!1),R=(0,n.useRef)(null),O=b&&("gestor"===b.role||"aforador"===b.role||"ejecutivo"===b.role||"coordinadora"===b.role);(0,n.useEffect)(()=>{if(!a||!f)return;I(!0);let e=(0,i.rJ)(o.db,"examenesPrevios/".concat(f,"/comments")),t=(0,i.P)(e,(0,i.My)("createdAt","asc")),s=(0,i.aQ)(t,e=>{let a=[];e.forEach(e=>{a.push({id:e.id,...e.data()})}),j(a),I(!1)},e=>{console.error("Error fetching comments: ",e),v({title:"Error",description:"No se pudieron cargar los comentarios.",variant:"destructive"}),I(!1)});return()=>s()},[a,f,v]),(0,n.useEffect)(()=>{if(R.current){let e=R.current.querySelector("[data-radix-scroll-area-viewport]");e&&(e.scrollTop=e.scrollHeight)}},[E]);let M=async()=>{if(!y.trim()||!b||!b.displayName||!b.role)return void v({title:"Error",description:"El comentario no puede estar vac\xedo y debes estar autenticado.",variant:"destructive"});if(!O)return void v({title:"Acci\xf3n no permitida",description:"No tienes permisos para comentar.",variant:"destructive"});w(!0);try{let e=(0,i.rJ)(o.db,"examenesPrevios/".concat(f,"/comments"));await (0,i.gS)(e,{text:y.trim(),authorId:b.uid,authorName:b.displayName,authorRole:b.role,authorRoleTitle:b.roleTitle||null,createdAt:(0,i.O5)()}),C("")}catch(e){console.error("Error adding comment: ",e),v({title:"Error",description:"No se pudo a\xf1adir el comentario.",variant:"destructive"})}finally{w(!1)}};return a?(0,s.jsx)(d.lG,{open:a,onOpenChange:e=>!e&&t(),children:(0,s.jsxs)(d.Cf,{className:"max-w-lg w-full p-0 flex flex-col h-[70vh] sm:h-[80vh]",children:[(0,s.jsxs)(d.c7,{className:"p-4 border-b",children:[(0,s.jsx)(d.L3,{className:"text-xl",children:"Bit\xe1cora del Examen"}),(0,s.jsx)(d.rr,{children:"Comentarios y notas sobre este examen previo."}),(0,s.jsx)("button",{onClick:t,className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","aria-label":"Cerrar",children:(0,s.jsx)(m.A,{className:"h-6 w-6"})})]}),(0,s.jsx)(u.F,{className:"flex-1",ref:R,children:(0,s.jsxs)("div",{className:"p-4 space-y-4",children:[D&&(0,s.jsx)("div",{className:"flex justify-center items-center py-8",children:(0,s.jsx)(p.A,{className:"h-8 w-8 animate-spin text-primary"})}),!D&&0===E.length&&(0,s.jsx)("div",{className:"text-center text-muted-foreground py-8",children:"No hay comentarios en esta bit\xe1cora."}),!D&&E.map((e,a)=>{var t;return(0,s.jsx)("div",{className:(0,N.cn)("flex items-start gap-3",e.authorId===(null==b?void 0:b.uid)&&"justify-end"),children:(0,s.jsxs)("div",{className:(0,N.cn)("rounded-lg p-3 max-w-[80%] w-fit",e.authorId===(null==b?void 0:b.uid)?"bg-primary text-primary-foreground":"bg-muted"),children:[(0,s.jsxs)("p",{className:"text-sm font-semibold",children:[e.authorName," ",(0,s.jsxs)("span",{className:"text-xs opacity-80 font-normal",children:["(",e.authorRoleTitle||e.authorRole,")"]})]}),(0,s.jsx)("p",{className:"text-sm mt-1 whitespace-pre-wrap",children:e.text}),(0,s.jsx)("p",{className:(0,N.cn)("text-xs opacity-70 mt-2",e.authorId===(null==b?void 0:b.uid)?"text-right":"text-left"),children:(t=e.createdAt)?(0,g.m)(t.toDate(),{addSuffix:!0,locale:A.es}):"Justo ahora"})]})},e.id||a)})]})}),O&&(0,s.jsx)(d.Es,{className:"p-4 border-t bg-background",children:(0,s.jsxs)("div",{className:"flex w-full items-center gap-2",children:[(0,s.jsx)(c.T,{placeholder:"Escribe un comentario...",value:y,onChange:e=>C(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),M())},className:"min-h-0 h-12 resize-none",rows:1,disabled:S}),(0,s.jsxs)(l.$,{onClick:M,disabled:S||!y.trim(),size:"icon",className:"shrink-0",children:[S?(0,s.jsx)(p.A,{className:"h-4 w-4 animate-spin"}):(0,s.jsx)(x.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"sr-only",children:"Enviar"})]})]})})]})}):null}}}]);